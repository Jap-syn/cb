<?php
chdir(dirname(__DIR__));

// Setup autoloading
require 'init_autoloader.php';

setlocale( LC_ALL, 'ja_JP.UTF-8' );
ini_set( 'default_charset', 'UTF-8' );
mb_internal_encoding( 'UTF-8' );
mb_http_output('UTF-8');
mb_regex_encoding( 'UTF-8' );

ini_set( 'max_execution_time', 0 );


use Coral\Base\Application\BaseApplicationAbstract;
use Coral\Base\BaseLog;
use Zend\Db\Adapter\Adapter;
use Zend\Config\Reader\Ini;
use models\Table\TableUser;
use models\Logic\LogicCancel;
use models\Logic\OrderCancelException;


/**
 * アプリケーションクラスです。
 *
 */
class Application extends BaseApplicationAbstract {
    protected $_application_id = 'tools-CancelRegister-batch';

    /**
     * Application の唯一のインスタンスを取得します。
     *
     * @static
     * @access public
     * @return Application
     */
    public static function getInstance() {
        if( self::$_instance === null ) {
            self::$_instance = new self();
        }

        return self::$_instance;
    }

    /**
     * Application の新しいインスタンスを初期化します。
     *
     * @ignore
     * @access private
     */
    private function __construct() {
        parent::init();
    }

    /**
     * @var Adapter
     */
    public $dbAdapter;

    /**
     * @var BaseLog
     */
    public $logger;


    /**
     * アプリケーションを実行します。
     *
     * @access public
     */
    public function run() {
        $exitCode = 1;

        try {

            // 実行確認
            echo "Run the Cancel batch. Is it OK?(Y/N)";
            $yn = trim(fgets(STDIN));
            if (strtoupper($yn) != 'Y') {
                echo "It has stopped the execution. ";
                exit(0);
            }

            // iniファイルから設定を取得
            $configPath = __DIR__ . '/../module/cbadmin/config/config.ini';

            // データベースアダプタをiniファイルから初期化します
            $data = array();
            if (file_exists($configPath))
            {
                $reader = new Ini();
                $data = $reader->fromFile($configPath);
            }
            $this->dbAdapter = new Adapter($data['database']);

            // ログ設定の読み込み
            $logConfig = $data['log'];
            // 標準ログクラス初期化
            $this->logger = BaseLog::createFromArray( $logConfig );
$this->logger->info('_data_patch_20200116_1500_CancelRegister.php start');

            $globalConfig = include __DIR__ . '/../config/autoload/global.php';
            // 接続時間を設定する
            $rds_session_timezone = $globalConfig['RDS_SESSION_TIMEZONE'];
            if (isset($rds_session_timezone)) {
                $this->dbAdapter->query('SET SESSION time_zone = :time_zone')->execute(array(':time_zone'=>$rds_session_timezone));
            }

            // 設定をシステムプロパティテーブルから読み込み
            $apinfo = $this->getApplicationiInfo($this->dbAdapter, 'cbadmin');
            // iniファイルの内容をマージ
            $data = array_merge($data, $apinfo);

            // ユーザーID取得
            $mdlu = new TableUser($this->dbAdapter);
            $userId = $mdlu->getUserId(TableUser::USERCLASS_SYSTEM, TableUser::SEQ_BATCH_USER);

            $this->dbAdapter->getDriver()->getConnection()->beginTransaction();


            // ------------------------------------------------------------------------->
            // 対象の定義
            $target = array(
'AK41114969',
'AK41120496',
'AK41157867',
'AK41129122',
'AK41145488',
'AK41120482',
'AK41158898',
'AK40693639',
'AK41135097',
'AK41131602',
'AK41139050',
'AK41060550',
'AK40683950',
'AK41124676',
'AK41133870',
'AK41139129',
'AK41126114',
'AK41151154',
'AK40498599',
'AK41152054',
'AK41161338',
'AK41158331',
'AK41156897',
'AK41156446',
'AK41152779',
'AK41151851',
'AK41151303',
'AK41148321',
'AK41148010',
'AK41147929',
'AK41147421',
'AK41147011',
'AK41145174',
'AK41137841',
'AK41133466',
'AK41131261',
'AK41116632',
'AK41137890',
'AK41152252',
'AK41151732',
'AK41151392',
'AK41148730',
'AK41120553',
'AK41151799',
'AK41154783',
'AK41146651',
'AK41138744',
'AK41131384',
'AK41120273',
'AK41115849',
'AK41128883',
'AK40695663',
'AK41153195',
'AK41139159',
'AK41156043',
'AK41116537',
'AK40692962',
'AK41154786',
'AK41116410',
'AK40679769',
'AK41115622',
'AK41153149',
'AK41160655',
'AK41124780',
'AK41124445',
'AK41131429',
'AK41151106',
'AK41138990',
'AK40498562',
'AK39766208',
'AK41155826',
'AK41144692',
'AK40501763',
'AK41150348',
'AK40682100',
'AK41126634',
'AK40492272',
'AK41114907',
'AK41165623',
'AK41138930',
'AK41120542',
'AK41151739',
'AK39779451',
'AK39760065',
'AK40684935',
'AK41152552',
'AK41148196',
'AK41158134',
'AK41117291',
'AK41144731',
'AK41115157',
'AK41149220',
'AK41060617',
'AK41160166',
'AK41164370',
'AK41124517',
'AK41115459',
'AK41154245',
'AK41124818',
'AK41129424',
'AK41124100',
'AK41152605',
'AK41120240',
'AK41116807',
'AK41116374',
'AK41117401',
'AK41153171',
'AK41146984',
'AK41157327',
'AK41148185',
'AK41142065',
'AK41124664',
'AK41151321',
'AK41158097',
'AK41152307',
'AK41145633',
'AK41153948',
'AK41144353',
'AK41135814',
'AK41119180',
'AK41148020',
'AK41138837',
'AK41152936',
'AK41060496',
'AK41146707',
'AK41155806',
'AK41140973',
'AK41151141',
'AK41149673',
'AK41118963',
'AK41152234',
'AK41143470',
'AK41150162',
'AK41155668',
'AK41155037',
'AK40692206',
'AK41130462',
'AK41120547',
'AK41136119',
'AK41159155',
'AK41133957',
'AK41152889',
'AK41118692',
'AK41140222',
'AK41151584',
'AK41148287',
'AK41118216',
'AK41120135',
'AK41203187',
'AK41150814',
'AK41117132',
'AK41146915',
'AK41151713',
'AK41117715',
'AK41154078',
'AK41151533',
'AK41166689',
'AK41148530',
'AK41143057',
'AK41128431',
'AK41153272',
'AK41125292',
'AK41135295',
'AK41115022',
'AK41155651',
'AK41154090',
'AK41134982',
'AK41124798',
'AK41149374',
'AK41120790',
'AK41130951',
'AK41157345',
'AK41115399',
'AK41151715',
'AK41155603',
'AK41116787',
'AK41149557',
'AK41117933',
'AK41120624',
'AK41148006',
'AK41131386',
'AK41151530',
'AK41157349',
'AK41147378',
'AK41153795',
'AK41137379',
'AK41157821',
'AK41146705',
'AK41148594',
'AK41147996',
'AK41153333',
'AK41146929',
'AK41140106',
'AK41150772',
'AK41155147',
'AK41150007',
'AK41132657',
'AK41119758',
'AK41118396',
'AK41146860',
'AK41129410',
'AK41124619',
'AK41163432',
'AK41166693',
'AK41158525',
'AK41158545',
'AK41162256',
'AK41141703',
'AK41148756',
'AK41151577',
'AK41151489',
'AK41117394',
'AK41147341',
'AK41152427',
'AK41157036',
'AK41148782',
'AK41119022',
'AK41118919',
'AK41152753',
'AK41157363',
'AK41120110',
'AK41150485',
'AK41164118',
'AK41120082',
'AK41155395',
'AK41151887',
'AK41151450',
'AK41131229',
'AK41134547',
'AK40489842',
'AK41139053',
'AK41148588',
'AK41149772',
'AK41143268',
'AK41118633',
'AK41118766',
'AK39776106',
'AK40684201',
'AK40500748',
'AK41203033',
'AK41202638',
'AK41202778',
'AK41202878',
'AK41160234',
'AK41160453',
'AK41158978',
'AK41157754',
'AK41158856',
'AK41160000',
'AK41166400',
'AK41158810',
'AK41156910',
'AK41155620',
'AK41157730',
'AK41154540',
'AK41158640',
'AK41160050',
'AK41159260',
'AK41160560',
'AK41155370',
'AK41155770',
'AK41155870',
'AK41160180',
'AK41155880',
'AK41160290',
'AK41160390',
'AK41160501',
'AK41157501',
'AK41158311',
'AK41159221',
'AK41156921',
'AK41157431',
'AK41164351',
'AK41158851',
'AK41166261',
'AK41155461',
'AK41158871',
'AK41160971',
'AK41154971',
'AK41162581',
'AK41158681',
'AK41156591',
'AK41160002',
'AK41158202',
'AK41158902',
'AK41158112',
'AK41163212',
'AK41155912',
'AK41156032',
'AK41159932',
'AK41154342',
'AK41156442',
'AK41154742',
'AK41157842',
'AK41156942',
'AK41160052',
'AK41166552',
'AK41161852',
'AK41157852',
'AK41154672',
'AK41161972',
'AK41158682',
'AK41160492',
'AK41166692',
'AK41160303',
'AK41161903',
'AK41157113',
'AK41159113',
'AK41155423',
'AK41156233',
'AK41156433',
'AK41166143',
'AK41159643',
'AK41157743',
'AK41162253',
'AK41157653',
'AK41163173',
'AK41160083',
'AK41160983',
'AK41158983',
'AK41157393',
'AK41154493',
'AK41155593',
'AK41161304',
'AK41154304',
'AK41164924',
'AK41159934',
'AK41157144',
'AK41155644',
'AK41160744',
'AK41158744',
'AK41158844',
'AK41158954',
'AK41157064',
'AK41156864',
'AK41158674',
'AK41158884',
'AK41155294',
'AK41157294',
'AK41155215',
'AK41155615',
'AK41155725',
'AK41160135',
'AK41155245',
'AK41166645',
'AK41156555',
'AK41157865',
'AK41164075',
'AK41157685',
'AK41160795',
'AK41155306',
'AK41154416',
'AK41157616',
'AK41156126',
'AK41155726',
'AK41163036',
'AK41156236',
'AK41160446',
'AK41159846',
'AK41156066',
'AK41157166',
'AK41157266',
'AK41155666',
'AK41156666',
'AK41157866',
'AK41154276',
'AK41155686',
'AK41156196',
'AK41157396',
'AK41161817',
'AK41158817',
'AK41158247',
'AK41162957',
'AK41157957',
'AK41155467',
'AK41154977',
'AK41161187',
'AK41155097',
'AK41158197',
'AK41159508',
'AK41155618',
'AK41157918',
'AK41155428',
'AK41158428',
'AK41154928',
'AK41154438',
'AK41155648',
'AK41156258',
'AK41160178',
'AK41156278',
'AK41161578',
'AK41158088',
'AK41160398',
'AK41155309',
'AK41154719',
'AK41155719',
'AK41154819',
'AK41155819',
'AK41162139',
'AK41154739',
'AK41158839',
'AK41155049',
'AK41154349',
'AK41158749',
'AK41157959',
'AK41158369',
'AK41157869',
'AK41159789',
'AK41155989',
'AK41157799',
'AK41142980',
'AK41152785',
'AK41150962',
'AK41149254',
'AK41147485',
'AK41146866',
'AK41145390',
'AK41139136',
'AK41124055',
'AK41151554',
'AK41130100',
'AK41151300',
'AK41119300',
'AK41133700',
'AK41151800',
'AK41132800',
'AK41124110',
'AK41142310',
'AK41125510',
'AK41124610',
'AK41153810',
'AK41128810',
'AK41149820',
'AK41135030',
'AK41152630',
'AK41152830',
'AK41151930',
'AK41147540',
'AK41124640',
'AK41138640',
'AK41138250',
'AK41150450',
'AK41153550',
'AK41124650',
'AK41125460',
'AK41151560',
'AK41150660',
'AK41150170',
'AK41126480',
'AK41120580',
'AK41148980',
'AK41150090',
'AK41146390',
'AK41151990',
'AK41141201',
'AK41149301',
'AK41148601',
'AK41151801',
'AK41142801',
'AK41149801',
'AK41151811',
'AK41127811',
'AK41152911',
'AK41124321',
'AK41124621',
'AK41126621',
'AK41141031',
'AK41120131',
'AK41137431',
'AK41129531',
'AK41153931',
'AK41120341',
'AK41131341',
'AK41137441',
'AK41151051',
'AK41148251',
'AK41146951',
'AK41119951',
'AK41126461',
'AK41145561',
'AK41147561',
'AK41148761',
'AK41147071',
'AK41153271',
'AK41145271',
'AK41151771',
'AK41152871',
'AK41148181',
'AK41124281',
'AK41153381',
'AK41146981',
'AK41147091',
'AK41153391',
'AK41144391',
'AK41150491',
'AK41138591',
'AK41153691',
'AK41124691',
'AK41151791',
'AK41152791',
'AK41148791',
'AK41154102',
'AK41148102',
'AK41138402',
'AK41128902',
'AK41124112',
'AK41142212',
'AK41149412',
'AK41152612',
'AK41120712',
'AK41124712',
'AK41151812',
'AK41131222',
'AK41138222',
'AK41152322',
'AK41119322',
'AK41141422',
'AK41153522',
'AK41145622',
'AK41126622',
'AK41147622',
'AK41126722',
'AK41137822',
'AK41152922',
'AK41152532',
'AK41148442',
'AK41144742',
'AK41133452',
'AK41147552',
'AK41147362',
'AK41151072',
'AK41152272',
'AK41153472',
'AK41146772',
'AK41148482',
'AK41153582',
'AK41151682',
'AK41146982',
'AK41145392',
'AK41119492',
'AK41141792',
'AK41152792',
'AK41129003',
'AK41144503',
'AK41145013',
'AK41134213',
'AK41128323',
'AK41124623',
'AK41153723',
'AK41138723',
'AK41141033',
'AK41147533',
'AK41150543',
'AK41145543',
'AK41147543',
'AK41150643',
'AK41153943',
'AK41139553',
'AK41150653',
'AK41153753',
'AK41141853',
'AK41152063',
'AK41148063',
'AK41147163',
'AK41125463',
'AK41153763',
'AK41152863',
'AK41150963',
'AK41143963',
'AK41151773',
'AK41128873',
'AK41126083',
'AK41150183',
'AK41124183',
'AK41145483',
'AK41123983',
'AK41134093',
'AK41151193',
'AK41139393',
'AK41126593',
'AK41141893',
'AK41129104',
'AK41145404',
'AK41125504',
'AK41137904',
'AK41136114',
'AK41152514',
'AK41147814',
'AK41119424',
'AK41145524',
'AK41152924',
'AK41139034',
'AK41148234',
'AK41120534',
'AK41125834',
'AK41150934',
'AK41124934',
'AK41153344',
'AK41151744',
'AK41146944',
'AK41124054',
'AK41126054',
'AK41129154',
'AK41124454',
'AK41153554',
'AK41124654',
'AK41133264',
'AK41148264',
'AK41153664',
'AK41140864',
'AK41136964',
'AK41139074',
'AK41151274',
'AK41128474',
'AK41124674',
'AK41146674',
'AK41151774',
'AK41152774',
'AK41126484',
'AK41123984',
'AK41154094',
'AK41148794',
'AK41146994',
'AK41138994',
'AK41153105',
'AK41139105',
'AK41141405',
'AK41124705',
'AK41124015',
'AK41152515',
'AK41128615',
'AK41139815',
'AK41148125',
'AK41129225',
'AK41138725',
'AK41141135',
'AK41145435',
'AK41125535',
'AK41153835',
'AK41141045',
'AK41148245',
'AK41153645',
'AK41151055',
'AK41151355',
'AK41120855',
'AK41150665',
'AK41151965',
'AK41123965',
'AK41151175',
'AK41144785',
'AK41120885',
'AK41150106',
'AK41141206',
'AK41148206',
'AK41124306',
'AK41153406',
'AK41145406',
'AK41149406',
'AK41139016',
'AK41151316',
'AK41146316',
'AK41134516',
'AK41151716',
'AK41151816',
'AK41153916',
'AK41141226',
'AK41126626',
'AK41147626',
'AK41129626',
'AK41152926',
'AK41138926',
'AK41141036',
'AK41126136',
'AK41135536',
'AK41151736',
'AK41133836',
'AK41145836',
'AK41152046',
'AK41148146',
'AK41147246',
'AK41145846',
'AK41119846',
'AK41147946',
'AK41148656',
'AK41151066',
'AK41153566',
'AK41129566',
'AK41149566',
'AK41150666',
'AK41152766',
'AK41140966',
'AK41140076',
'AK41142676',
'AK41148676',
'AK41126976',
'AK41146976',
'AK41138976',
'AK41153186',
'AK41131486',
'AK41127686',
'AK41125196',
'AK41153396',
'AK41150596',
'AK41144596',
'AK41146996',
'AK41125107',
'AK41147207',
'AK41148307',
'AK41139307',
'AK41152507',
'AK41152707',
'AK41150807',
'AK41121117',
'AK41135117',
'AK41152217',
'AK41140317',
'AK41126617',
'AK41133717',
'AK41152917',
'AK41139027',
'AK41139127',
'AK41145327',
'AK41147427',
'AK41131237',
'AK41148237',
'AK41147537',
'AK41153637',
'AK41150937',
'AK41154047',
'AK41129347',
'AK41153547',
'AK41148257',
'AK41127357',
'AK41143657',
'AK41152757',
'AK41120857',
'AK41137957',
'AK41138957',
'AK41141067',
'AK41119267',
'AK41144367',
'AK41153567',
'AK41125567',
'AK41150667',
'AK41151867',
'AK41152867',
'AK41153867',
'AK41146967',
'AK41126477',
'AK41147677',
'AK41153087',
'AK41124287',
'AK41149487',
'AK41153987',
'AK41125297',
'AK41127397',
'AK41152497',
'AK41129597',
'AK41133697',
'AK41148797',
'AK41140897',
'AK41123897',
'AK41131008',
'AK41153008',
'AK41151308',
'AK41151408',
'AK41152408',
'AK41135508',
'AK41153808',
'AK41148808',
'AK41150018',
'AK41133318',
'AK41151518',
'AK41153718',
'AK41138718',
'AK41148818',
'AK41148228',
'AK41144328',
'AK41151638',
'AK41146838',
'AK41151048',
'AK41152048',
'AK41135248',
'AK41153548',
'AK41124648',
'AK41148648',
'AK41125748',
'AK41138748',
'AK41120558',
'AK41131658',
'AK41139168',
'AK41153468',
'AK41139468',
'AK41152568',
'AK41147568',
'AK41151868',
'AK41137868',
'AK41144478',
'AK41153978',
'AK41152388',
'AK41145388',
'AK41147588',
'AK41147888',
'AK41128988',
'AK41151398',
'AK41152498',
'AK41129498',
'AK41150698',
'AK41119698',
'AK41152798',
'AK41130898',
'AK41154009',
'AK41139009',
'AK41138309',
'AK41126509',
'AK41148509',
'AK41128609',
'AK41121119',
'AK41135419',
'AK41145419',
'AK41152519',
'AK41144719',
'AK41139719',
'AK41139819',
'AK41133919',
'AK41147919',
'AK41152229',
'AK41153229',
'AK41135529',
'AK41151829',
'AK41124929',
'AK41126139',
'AK41152539',
'AK41147539',
'AK41153639',
'AK41135639',
'AK41144739',
'AK41149739',
'AK41125049',
'AK41135449',
'AK41149449',
'AK41147259',
'AK41140659',
'AK41154069',
'AK41152169',
'AK41153569',
'AK41146969',
'AK41125079',
'AK41124679',
'AK41148189',
'AK41149389',
'AK41125689',
'AK41135689',
'AK41148689',
'AK41133989',
'AK41152199',
'AK41151299',
'AK41148299',
'AK41149299',
'AK41146499',
'AK41147599',
'AK41146999',
'AK41119200',
'AK41118920',
'AK41118260',
'AK41116280',
'AK41118490',
'AK41114890',
'AK41115101',
'AK41116711',
'AK41116031',
'AK41116871',
'AK41116481',
'AK41116702',
'AK41115212',
'AK41117422',
'AK41117792',
'AK41117333',
'AK41119204',
'AK41117014',
'AK41115814',
'AK41115824',
'AK41115734',
'AK41119184',
'AK41115935',
'AK41119055',
'AK41115755',
'AK41115895',
'AK41118406',
'AK41115416',
'AK41118146',
'AK41116366',
'AK41119076',
'AK41119086',
'AK41115196',
'AK41119207',
'AK41115227',
'AK41116227',
'AK41115037',
'AK41119157',
'AK41117857',
'AK41118857',
'AK41116177',
'AK41117697',
'AK41115508',
'AK41115908',
'AK41119138',
'AK41117238',
'AK41119148',
'AK41117058',
'AK41118858',
'AK41119178',
'AK41118488',
'AK41117598',
'AK41116719',
'AK41115759',
'AK41115879',
'AK41060502',
'AK41060611',
'AK41060393',
'AK41060439',
'AK41124369',
'AK41162375',
'AK41155125',
            );

            // キャンセル理由の定義
            $reason = '';
            $reasonCode = 8;
            // <-------------------------------------------------------------------------

            $logic = new LogicCancel($this->dbAdapter);

            // 対象データ分ループ
            foreach ($target as $orderId) {
                // $this->logger->info('[' . $orderId . '] Start ');

                // 注文SEQを特定する
                $sql = ' SELECT * FROM T_Order WHERE OrderId = :OrderId ';
                $prm = array(
                    ':OrderId' => $orderId,
                );

                $row = $this->dbAdapter->query($sql)->execute($prm)->current();

                if (!$row) {
                    // 特定できない場合はアラート出力⇒次の行へ
                    $this->logger->warn('<CancelRegister> [' . $orderId . '] OrderId Is Not Found!!');
                    continue;
                }

                // 注文SEQ特定
                $oseq = $row['OrderSeq'];

                // キャンセル申請処理を行う
                try {
                    $logic->applies($oseq, $reason, $reasonCode, 1, false, $userId);
                    $this->logger->info('<CancelRegister> [' . $orderId . '] Complete!! ');
                } catch(OrderCancelException $oce) {
                    $this->logger->warn('<CancelRegister> [' . $orderId . '] Order Is Not Cancel Message = ' . $oce->getMessage());
                    $this->logger->warn('<CancelRegister> [' . $orderId . '] ' . $oce->getTraceAsString());
                }

            }

            // $this->dbAdapter->getDriver()->getConnection()->rollback();
            $this->dbAdapter->getDriver()->getConnection()->commit();

            $exitCode = 0; // 正常終了
$this->logger->info('_data_patch_20200116_1500_CancelRegister.php end');

        } catch( \Exception $e ) {
            try{
                $this->dbAdapter->getDriver()->getConnection()->rollback();
            } catch ( \Exception $err) { }

            // エラーログを出力
            if ( isset($this->logger) ) {
$this->logger->err('<CancelRegister> ' . $e->getMessage());
$this->logger->err('<CancelRegister> ' . $e->getTraceAsString());
            }
        }

        // 終了コードを指定して処理終了
        exit($exitCode);

    }
}

Application::getInstance()->run();
