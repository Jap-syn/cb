<?php
chdir(dirname(__DIR__));

// Setup autoloading
require 'init_autoloader.php';

setlocale( LC_ALL, 'ja_JP.UTF-8' );
ini_set( 'default_charset', 'UTF-8' );
mb_internal_encoding( 'UTF-8' );
mb_http_output('UTF-8');
mb_regex_encoding( 'UTF-8' );

ini_set( 'max_execution_time', 0 );


use Coral\Base\Application\BaseApplicationAbstract;
use Coral\Base\BaseLog;
use Zend\Db\Adapter\Adapter;
use Zend\Config\Reader\Ini;
use models\Table\TableUser;
use models\Table\TableOrder;
use models\Table\TableCancel;
use models\Table\TablePayingAndSales;
use models\Table\TableStampFee;
use models\Table\TableOemSettlementFee;
use models\Table\TableOemClaimFee;
use models\Table\TableClaimControl;
use Coral\Coral\Mail\CoralMail;
use models\Logic\LogicCancel;
use Coral\Coral\History\CoralHistoryOrder;
use models\Logic\LogicSmbcRelation;
use models\Logic\Jnb\LogicJnbAccount;
use models\Table\TableReceiptControl;
use models\Table\ATableReceiptControl;
use models\Table\TableSundryControl;
use models\Table\TableStagnationAlert;


/**
 * アプリケーションクラスです。
 *
 */
class Application extends BaseApplicationAbstract {
    protected $_application_id = 'tools-CancelRegister-batch';

    /**
     * Application の唯一のインスタンスを取得します。
     *
     * @static
     * @access public
     * @return Application
     */
    public static function getInstance() {
        if( self::$_instance === null ) {
            self::$_instance = new self();
        }

        return self::$_instance;
    }

    /**
     * Application の新しいインスタンスを初期化します。
     *
     * @ignore
     * @access private
     */
    private function __construct() {
        parent::init();
    }

    /**
     * @var Adapter
     */
    public $dbAdapter;

    /**
     * @var BaseLog
     */
    public $logger;

    /**
     * メール環境
     */
    public $mail;

    /**
     * アプリケーションを実行します。
     *
     * @access public
     */
    public function run() {
        $exitCode = 1;

        error_reporting(0);

        try {

            // 実行確認
            echo "Run the Double Receipt Patch. Is it OK?(Y/N)";
            $yn = trim(fgets(STDIN));
            if (strtoupper($yn) != 'Y') {
                echo "It has stopped the execution. ";
                exit(0);
            }

            $start = microtime(true);

            // iniファイルから設定を取得
            $configPath = __DIR__ . '/../module/cbadmin/config/config.ini';

            // データベースアダプタをiniファイルから初期化します
            $data = array();
            if (file_exists($configPath))
            {
                $reader = new Ini();
                $data = $reader->fromFile($configPath);
            }
            $this->dbAdapter = new Adapter($data['database']);

            // ログ設定の読み込み
            $logConfig = $data['log'];
            // 標準ログクラス初期化
            $this->logger = BaseLog::createFromArray( $logConfig );
$this->logger->info('_data_patch_20180502_1000_DoubleReceiptPatch.php start');

            $globalConfig = include __DIR__ . '/../config/autoload/global.php';
            // 接続時間を設定する
            $rds_session_timezone = $globalConfig['RDS_SESSION_TIMEZONE'];
            if (isset($rds_session_timezone)) {
                $this->dbAdapter->query('SET SESSION time_zone = :time_zone')->execute(array(':time_zone'=>$rds_session_timezone));
            }

            // 設定をシステムプロパティテーブルから読み込み
            $apinfo = $this->getApplicationiInfo($this->dbAdapter, 'cbadmin');
            // iniファイルの内容をマージ
            $data = array_merge($data, $apinfo);
            // メールに絡む属性
            $this->mail = $data['mail'];

            // ユーザーID取得
            $mdlu = new TableUser($this->dbAdapter);
            $userId = $mdlu->getUserId(TableUser::USERCLASS_SYSTEM, TableUser::SEQ_BATCH_USER);

            // ------------------------------------------------------------------------->
            // 注文SEQのリスト
            $arrOseq = array(
                    '32963858',
                    '33072892',
                    '33261142',
                    '33295771',
                    '32960064',
                    '33313258',
                    '33348631',
                    '33349457',
                    '33349482',
                    '33337871',
                    '33361198',
                    '33378058',
                    '33373035',
                    '33381301',
                    '33388961',
                    '33029556',
                    '33029619',
                    '33431009',
                    '33418771',
                    '33063153',
                    '33427272',
                    '33410987',
                    '33079343',
                    '33464349',
                    '33462848',
                    '33112033',
                    '33165310',
                    '33470600',
                    '33492171',
                    '33478174',
                    '33463613',
                    '33082367',
                    '33132388',
                    '33511949',
                    '33495921',
                    '33497797',
                    '33148866',
                    '33514024',
                    '33535226',
                    '33163579',
                    '33544263',
                    '33524291',
                    '33457835',
                    '33516380',
                    '33516150',
                    '33550426',
                    '33512508',
                    '33526291',
                    '33177668',
                    '33177730',
                    '33516147',
                    '33533292',
                    '33570566',
                    '33566486',
                    '33580059',
                    '33542846',
                    '33592847',
                    '33514123',
                    '33206539',
                    '33240219',
                    '33245590',
                    '33252677',
                    '33569530',
                    '33573894',
                    '33544868',
                    '33584754',
                    '33585442',
                    '33586255',
                    '33570546',
                    '33537815',
                    '33229789',
                    '33575997',
                    '33436493',
                    '33576037',
                    '33604504',
                    '33597053',
                    '33612207',
                    '33614000',
                    '33622427',
                    '33601803',
                    '33582476',
                    '33606096',
                    '33627119',
                    '33628545',
                    '33627825',
                    '33606092',
                    '33521850',
                    '33629143',
                    '33566488',
                    '33574315',
                    '33624516',
                    '33619043',
                    '33616683',
                    '33635444',
                    '33542683',
                    '33574518',
                    '33616685',
                    '33252861',
                    '33623550',
                    '33628499',
                    '33587435',
                    '33604566',
                    '33586589',
                    '33586793',
                    '33517111',
                    '33587079',
                    '33587133',
                    '33597696',
                    '33572145',
                    '33597590',
                    '33536918',
                    '33619148',
                    '33537033',
                    '33537155',
                    '33537002',
                    '33537013',
                    '33537098',
                    '33537149',
                    '33528468',
                    '33536739',
                    '33536747',
                    '33536798',
                    '33536819',
                    '33622652',
                    '33634516',
                    '33543409',
                    '33630589',
                    '33658944',
                    '33093337',
                    '33616831',
                    '33623761',
                    '33630581',
                    '33645162',
                    '33571612',
                    '32900907',
                    '33620505',
                    '33630575',
                    '33658329',
                    '33267680',
                    '33267806',
                    '33267891',
                    '33667205',
                    '33671374',
                    '33620401',
                    '33662572',
                    '33620142',
                    '33669530',
                    '33636593',
                    '33669541',
                    '33568646',
                    '33669498',
                    '33674683',
                    '33638878',
                    '33693466',
                    '33615048',
                    '33649230',
                    '33673392',
                    '33629426',
                    '33670621',
                    '33348795',
                    '33666869',
                    '33670020',
                    '33650554',
                    '33660874',
                    '33636902',
                    '33668090',
                    '33652506',
                    '33662644',
                    '33629432',
                    '33649225',
                    '33669768',
                    '33668846',
                    '33662832',
                    '33641510',
                    '33629429',
                    '33670418',
                    '33669492',
                    '33665797',
                    '33669504',
                    '33649227',
                    '33666102',
                    '33664902',
                    '33630691',
                    '33642029',
                    '33642001',
                    '32988224',
                    '33086672',
                    '33083724',
                    '33084078',
                    '33085464',
                    '33083891',
                    '33084029',
                    '33083882',
                    '33084526',
                    '33085910',
                    '33088725',
                    '33084918',
                    '33088224',
                    '32729376',
                    '32729622',
                    '33096377',
                    '33377249',
                    '33102813',
                    '33090020',
                    '33056961',
                    '33025051',
                    '32973676',
                    '33290489',
                    '33411177',
                    '33411227',
                    '33411199',
                    '33411228',
                    '33411211',
                    '33471263',
                    '33083599',
                    '33083631',
                    '33083742',
                    '33084503',
                    '33084678',
                    '33084699',
                    '33084851',
                    '33084866',
                    '33085323',
                    '33085402',
                    '33085412',
                    '33085606',
                    '33085873',
                    '33085913',
                    '33086466',
                    '33086589',
                    '33086990',
                    '33087140',
                    '33087220',
                    '33087475',
                    '33087645',
                    '33087755',
                    '33087886',
                    '33087977',
                    '33088091',
                    '33088154',
                    '33088210',
                    '33088230',
                    '33088270',
                    '33088302',
                    '33088580',
                    '33088607',
                    '33088969',
                    '33089028',
                    '33482429',
                    '33503166',
                    '33503018',
                    '33502827',
                    '33499654',
                    '33498665',
                    '33499101',
                    '33503959',
                    '33503150',
                    '33504098',
                    '33500392',
                    '33500595',
                    '33500937',
                    '33502790',
                    '33502893',
                    '33502862',
                    '33503055',
                    '33503385',
                    '33503448',
                    '33498598',
                    '33503811',
                    '33502633',
                    '33503827',
                    '33503893',
                    '33503941',
                    '33504014',
                    '33498724',
                    '33500481',
                    '33501905',
                    '33501955',
                    '33502019',
                    '33502166',
                    '33502188',
                    '33502208',
                    '33502539',
                    '33502542',
                    '33502555',
                    '33502624',
                    '33503001',
                    '33504058',
                    '33503648',
                    '33498748',
                    '33498769',
                    '33498968',
                    '33503459',
                    '33503545',
                    '33503598',
                    '33503735',
                    '33503845',
                    '33504062',
                    '33500375',
                    '33503007',
                    '33502094',
                    '33502155',
                    '33500505',
                    '33500877',
                    '33502709',
                    '33500280',
                    '33498696',
                    '33499067',
                    '33499620',
                    '33501648',
                    '33499696',
                    '33501145',
                    '33503423',
                    '33500527',
                    '33501222',
                    '33501748',
                    '33501783',
                    '33501869',
                    '33503044',
                    '33503500',
                    '33502016',
                    '33500461',
                    '33501020',
                    '33501123',
                    '33501294',
                    '33498811',
                    '33499265',
                    '33498577',
                    '33498809',
                    '33500157',
                    '33500209',
                    '33501153',
                    '33502665',
                    '33502671',
                    '33502744',
                    '33503029',
                    '33503108',
                    '33503719',
                    '33504065',
                    '33503403',
                    '33500441',
                    '33500503',
                    '33501012',
                    '33500607',
                    '33500689',
                    '33501428',
                    '33501593',
                    '33501908',
                    '33501943',
                    '33501865',
                    '33501919',
                    '33498757',
                    '33499130',
                    '33502861',
                    '33501075',
                    '33501750',
                    '33502169',
                    '33504102',
                    '33501834',
                    '33501882',
                    '33501901',
                    '33502028',
                    '33502083',
                    '33502085',
                    '33502153',
                    '33502700',
                    '33498622',
                    '33499611',
                    '33502898',
                    '33503915',
                    '33503756',
                    '33501811',
                    '33502560',
                    '33502115',
                    '33502167',
                    '33502032',
                    '33500272',
                    '33498583',
                    '33499176',
                    '33502578',
                    '33502912',
                    '33503624',
                    '33500512',
                    '33500632',
                    '33500633',
                    '33500667',
                    '33500922',
                    '33501195',
                    '33501295',
                    '33501425',
                    '33501619',
                    '33501993',
                    '33502116',
                    '33502148',
                    '33502635',
                    '33501401',
                    '33501592',
                    '33500459',
                    '33501131',
                    '33501155',
                    '33503462',
                    '33504081',
                    '33502714',
                    '33501205',
                    '33501464',
                    '33501591',
                    '33503537',
                    '33501711',
                    '33498825',
                    '33501244',
                    '33499670',
                    '33498906',
                    '33499286',
                    '33501840',
                    '33502619',
                    '33501976',
                    '33502057',
                    '33502206',
                    '33500690',
                    '33501859',
                    '33503918',
                    '33499376',
                    '33500125',
                    '33500276',
                    '33498754',
                    '33499653',
                    '33501636',
                    '33501785',
                    '33502731',
                    '33503492',
                    '33501864',
                    '33501896',
                    '33501705',
                    '33500390',
                    '33501429',
                    '33502033',
                    '33501069',
                    '33500891',
                    '33501371',
                    '33498994',
                    '33499121',
                    '33499273',
                    '33499422',
                    '33499676',
                    '33502737',
                    '33503427',
                    '33503475',
                    '33502864',
                    '33503032',
                    '33503446',
                    '33503595',
                    '33498582',
                    '33500436',
                    '33503124',
                    '33503402',
                    '33501779',
                    '33502020',
                    '33498690',
                    '33498705',
                    '33498799',
                    '33498835',
                    '33499002',
                    '33499003',
                    '33499501',
                    '33499586',
                    '33499624',
                    '33499627',
                    '33499699',
                    '33500295',
                    '33498629',
                    '33498812',
                    '33499009',
                    '33499068',
                    '33499572',
                    '33499812',
                    '33500232',
                    '33500243',
                    '33501493',
                    '33502892',
                    '33498740',
                    '33500094',
                    '33500167',
                    '33498620',
                    '33499062',
                    '33499125',
                    '33499275',
                    '33499333',
                    '33499390',
                    '33499759',
                    '33499796',
                    '33499828',
                    '33501669',
                    '33502622',
                    '33502908',
                    '33503070',
                    '33503390',
                    '33503418',
                    '33503892',
                    '33498931',
                    '33503833',
                    '33503616',
                    '33503709',
                    '33503724',
                    '33503850',
                    '33503936',
                    '33503995',
                    '33504150',
                    '33501710',
                    '33502948',
                    '33503171',
                    '33504136',
                    '33504138',
                    '33498762',
                    '33498976',
                    '33499355',
                    '33499392',
                    '33499393',
                    '33499409',
                    '33499681',
                    '33499814',
                    '33500102',
                    '33500254',
                    '33500346',
                    '33501747',
                    '33502919',
                    '33498995',
                    '33498905',
                    '33504017',
                    '33500351',
                    '33500369',
                    '33500458',
                    '33500634',
                    '33500648',
                    '33501062',
                    '33501132',
                    '33501387',
                    '33501707',
                    '33503173',
                    '33498607',
                    '33498640',
                    '33501874',
                    '33502101',
                    '33500927',
                    '33501079',
                    '33498786',
                    '33498794',
                    '33498866',
                    '33499532',
                    '33499711',
                    '33500132',
                    '33500143',
                    '33501450',
                    '33500404',
                    '33501130',
                    '33501397',
                    '33501422',
                    '33502643',
                    '33502924',
                    '33498867',
                    '33499829',
                    '33500502',
                    '33501713',
                    '33498682',
                    '33499117',
                    '33501746',
                    '33501757',
                    '33501761',
                    '33502039',
                    '33502054',
                    '33502544',
                    '33502571',
                    '33502602',
                    '33502728',
                    '33502756',
                    '33502960',
                    '33502961',
                    '33502964',
                    '33502988',
                    '33503065',
                    '33503167',
                    '33503602',
                    '33503619',
                    '33503654',
                    '33503764',
                    '33503823',
                    '33504063',
                    '33498928',
                    '33499051',
                    '33499282',
                    '33500137',
                    '33500517',
                    '33500678',
                    '33501221',
                    '33501621',
                    '33501717',
                    '33498605',
                    '33499321',
                    '33499827',
                    '33500327',
                    '33501849',
                    '33502010',
                    '33499039',
                    '33499358',
                    '33503479',
                    '33501220',
                    '33501289',
                    '33498743',
                    '33498829',
                    '33499263',
                    '33499578',
                    '33500211',
                    '33501223',
                    '33503752',
                    '33498679',
                    '33499717',
                    '33498589',
                    '33498819',
                    '33498820',
                    '33499055',
                    '33499549',
                    '33499596',
                    '33500347',
                    '33501777',
                    '33502680',
                    '33503063',
                    '33498649',
                    '33498903',
                    '33502888',
                    '33500529',
                    '33500563',
                    '33500975',
                    '33500983',
                    '33501019',
                    '33501246',
                    '33501413',
                    '33501421',
                    '33501444',
                    '33502804',
                    '33502978',
                    '33500450',
                    '33500574',
                    '33502764',
                    '33502963',
                    '33498941',
                    '33498955',
                    '33498725',
                    '33498879',
                    '33499029',
                    '33499552',
                    '33499678',
                    '33500113',
                    '33500151',
                    '33500293',
                    '33502674',
                    '33498657',
                    '33499035',
                    '33499594',
                    '33500084',
                    '33499842',
                    '33503927',
                    '33498569',
                    '33498920',
                    '33499487',
                    '33502873',
                    '33500356',
                    '33500900',
                    '33501070',
                    '33501084',
                    '33501114',
                    '33501170',
                    '33501173',
                    '33501366',
                    '33498948',
                    '33499272',
                    '33501790',
                    '33500378',
                    '33500586',
                    '33502520',
                    '33503740',
                    '33499793',
                    '33499872',
                    '33500643',
                    '33501032',
                    '33501463',
                    '33504070',
                    '33501736',
                    '33498638',
                    '33498716',
                    '33498804',
                    '33498901',
                    '33499167',
                    '33499285',
                    '33499441',
                    '33499473',
                    '33500395',
                    '33500522',
                    '33500646',
                    '33501309',
                    '33501354',
                    '33501414',
                    '33502151',
                    '33498961',
                    '33499145',
                    '33499337',
                    '33499411',
                    '33499534',
                    '33500233',
                    '33500292',
                    '33502628',
                    '33498915',
                    '33499840',
                    '33501487',
                    '33501689',
                    '33501825',
                    '33502114',
                    '33503027',
                    '33498777',
                    '33498807',
                    '33498987',
                    '33499001',
                    '33499044',
                    '33499087',
                    '33499110',
                    '33499156',
                    '33499406',
                    '33499703',
                    '33499738',
                    '33500300',
                    '33500953',
                    '33501804',
                    '33502777',
                    '33503736',
                    '33499429',
                    '33501778',
                    '33499561',
                    '33500386',
                    '33500889',
                    '33501440',
                    '33501273',
                    '33500572',
                    '33500655',
                    '33500666',
                    '33501025',
                    '33501188',
                    '33501233',
                    '33501298',
                    '33501333',
                    '33500355',
                    '33500501',
                    '33500603',
                    '33501291',
                    '33500224',
                    '33498578',
                    '33499162',
                    '33499381',
                    '33501617',
                    '33502568',
                    '33502610',
                    '33503109',
                    '33503745',
                    '33498758',
                    '33499173',
                    '33499351',
                    '33500248',
                    '33503919',
                    '33501700',
                    '33501766',
                    '33503558',
                    '33503967',
                    '33500445',
                    '33500473',
                    '33500530',
                    '33500914',
                    '33500628',
                    '33501379',
                    '33501395',
                    '33502766',
                    '33498698',
                    '33498980',
                    '33498999',
                    '33499080',
                    '33499095',
                    '33499166',
                    '33499276',
                    '33499474',
                    '33499523',
                    '33499535',
                    '33499766',
                    '33500201',
                    '33500331',
                    '33501682',
                    '33503091',
                    '33503516',
                    '33499792',
                    '33500897',
                    '33501138',
                    '33500609',
                    '33500618',
                    '33500876',
                    '33501148',
                    '33501171',
                    '33501281',
                    '33501656',
                    '33503789',
                    '33501305',
                    '33499603',
                    '33498566',
                    '33500640',
                    '33500886',
                    '33501038',
                    '33501041',
                    '33499079',
                    '33499407',
                    '33499492',
                    '33499072',
                    '33499305',
                    '33499584',
                    '33501268',
                    '33500456',
                    '33500485',
                    '33501180',
                    '33501886',
                    '33501612',
                    '33501718',
                    '33501924',
                    '33503407',
                    '33504030',
                    '33503690',
                    '33500923',
                    '33501172',
                    '33503774',
                    '33503852',
                    '33501622',
                    '33501637',
                    '33503686',
                    '33503737',
                    '33503816',
                    '33503853',
                    '33503905',
                    '33504020',
                    '33504024',
                    '33503159',
                    '33499761',
                    '33499832',
                    '33501712',
                    '33502820',
                    '33503079',
                    '33500146',
                    '33500190',
                    '33499405',
                    '33499688',
                    '33499705',
                    '33501125',
                    '33501261',
                    '33501627',
                    '33502082',
                    '33502943',
                    '33502979',
                    '33503086',
                    '33501949',
                    '33501891',
                    '33502661',
                    '33502848',
                    '33503713',
                    '33503621',
                    '33503641',
                    '33503671',
                    '33503758',
                    '33503796',
                    '33503907',
                    '33503926',
                    '33504112',
                    '33500472',
                    '33500571',
                    '33500959',
                    '33501365',
                    '33500910',
                    '33500302',
                    '33498693',
                    '33499352',
                    '33500964',
                    '33502867',
                    '33502885',
                    '33503088',
                    '33503468',
                    '33503653',
                    '33502036',
                    '33501742',
                    '33502807',
                    '33503420',
                    '33501687',
                    '33502128',
                    '33502187',
                    '33502140',
                    '33502146',
                    '33516649',
                    '33516642',
                    '33509947',
                    '33549952',
                    '33349654',
                    '33516645',
                    '33543345',
                    '33567010',
                    '33575031',
                    '33592801',
                    '33588775',
                    '33588784',
                    '33588779',
                    '33576748',
                    '33588781',
                    '33588773',
                    '33501986',
                    '33619061',
                    '33567016',
                    '33604178',
                    '33574901',
                    '33605337',
                    '33611879',
                    '33547388',
                    '33588766',
                    '33592802',
                    '33088015',
                    '33088176',
                    '33576735',
                    '33636075',
                    '33619049',
                    '33619078',
                    '33576743',
                    '33547381',
                    '33636519',
                    '33611874',
                    '33543348',
                    '33570824',
                    '33626463',
                    '33588798',
                    '33624085',
                    '33619060',
                    '33611878',
                    '33570823',
                    '33657785',
                    '33659405',
                    '33653467',
                    '33636089',
                    '33653465',
                    '33609912',
                    '33653461',
                    '33659400',
                    '33665715',
                    '33653434',
                    '33640682',
                    '33624086',
                    '33653433',
                    '33665753',
                    '33588758',
                    '33665719',
                    '33574949',
                    '33665723',
                    '33653438',
                    '33643098',
                    '33659872',
                    '33653436',
                    '33665711',
                    '33654332',
                    '33636096',
                    '33636104',
                    '33543335',
                    '33667970',
                    '33668703',
                    '33673452',
                    '33671963',
                    '33674782',
                    '33668702',
                    '33665720',
                    '33668701',
                    '33668697',
                    '33665708',
                    '33674780',
                    '33643106',
                    '33665712',
                    '33668698',
                    '33668704',
                    '33674783',
                    '33671965',
                    '33671964',
                    '33671968',
                    '33206624',
                    '33268054',
                    '33267592',
                    '33295978',
                    '33295915',
                    '33314880',
                    '33314867',
                    '33271094',
                    '33329330',
                    '33344575',
                    '33359129',
                    '33359080',
                    '33358936',
                    '33358909',
                    '33368208',
                    '33388765',
                    '33414840',
                    '33419367',
                    '33421481',
                    '33441671',
                    '33448128',
                    '33448116',
                    '33448090',
                    '33448078',
                    '33448060',
                    '33448053',
                    '33448027',
                    '33448000',
                    '33447960',
                    '33447915',
                    '33447913',
                    '33447902',
                    '33447886',
                    '33447831',
                    '33447829',
                    '33447824',
                    '33476895',
                    '33476886',
                    '33476873',
                    '33476872',
                    '33476871',
                    '33476835',
                    '33471425',
                    '33425041',
                    '33481838',
                    '33494161',
                    '33494160',
                    '33498669',
                    '33508657',
                    '33532816',
                    '33532878',
                    '33538935',
                    '33538934',
                    '33538932',
                    '33538907',
                    '33538898',
                    '33538869',
                    '33538853',
                    '33538852',
                    '33538849',
                    '33538808',
                    '33538801',
                    '33538790',
                    '33538785',
                    '33538771',
                    '33538738',
                    '33538721',
                    '33538702',
                    '33538688',
                    '33538684',
                    '33538682',
                    '33538638',
                    '33538624',
                    '33538607',
                    '33538597',
                    '33538590',
                    '33535231',
                    '33535328',
                    '33543859',
                    '33545163',
                    '33544980',
                    '33547593',
                    '33580383',
                    '33580368',
                    '33580351',
                    '33580338',
                    '33580314',
                    '33580313',
                    '33580390',
                    '33573924',
                    '33579432',
                    '33591617',
                    '33591699',
                    '33588500',
                    '33600162',
                    '33603382',
                    '33603368',
                    '33603540',
                    '33452026',
                    '33595743',
                    '33595753',
                    '33609585',
                    '33614467',
                    '33614455',
                    '33614436',
                    '33614426',
                    '33614424',
                    '33614412',
                    '33544163',
                    '33610289',
                    '33611686',
                    '33530337',
                    '33611481',
                    '33619502',
                    '33628791',
                    '33628776',
                    '33628761',
                    '33628755',
                    '33628748',
                    '33628747',
                    '33628738',
                    '33628730',
                    '33532505',
                    '33625057',
                    '33611480',
                    '33617182',
                    '33625031',
                    '33631155',
                    '33627076',
                    '33634338',
                    '33639511',
                    '33639549',
                    '33625776',
                    '33625777',
                    '33636641',
                    '33639124',
                    '33646926',
                    '33646917',
                    '33646914',
                    '33646912',
                    '33646910',
                    '33646907',
                    '33646899',
                    '33646896',
                    '33646884',
                    '33646882',
                    '33646881',
                    '33646878',
                    '33646871',
                    '33646870',
                    '33646860',
                    '33646858',
                    '33646855',
                    '33646849',
                    '33646847',
                    '33646846',
                    '33646840',
                    '33646838',
                    '33646832',
                    '33646831',
                    '33646818',
                    '33646816',
                    '33646809',
                    '33646808',
                    '33646804',
                    '33646791',
                    '33646789',
                    '33646786',
                    '33646776',
                    '33646774',
                    '33646772',
                    '33646760',
                    '33646749',
                    '33646748',
                    '33646741',
                    '33646740',
                    '33646721',
                    '33646717',
                    '33646716',
                    '33646715',
                    '33646714',
                    '33646710',
                    '33646700',
                    '33646687',
                    '33646680',
                    '33646679',
                    '33646678',
                    '33646674',
                    '33646670',
                    '33646658',
                    '33646645',
                    '33646640',
                    '33646635',
                    '33646627',
                    '33646626',
                    '33646625',
                    '33646611',
                    '33646610',
                    '33646604',
                    '33646603',
                    '33646596',
                    '33646589',
                    '33646588',
                    '33646584',
                    '33646582',
                    '33646578',
                    '33646576',
                    '33646575',
                    '33646572',
                    '33646555',
                    '33646540',
                    '33646537',
                    '33646535',
                    '33646532',
                    '33646523',
                    '33646509',
                    '33646508',
                    '33646500',
                    '33646498',
                    '33646496',
                    '33646486',
                    '33640639',
                    '33642274',
                    '33547090',
                    '33633199',
                    '33633202',
                    '33633207',
                    '33651710',
                    '33651914',
                    '33652364',
                    '33645226',
                    '33421991',
                    '33651075',
                    '33651078',
                    '33657260',
                    '33659188',
                    '33657656',
                    '33658253',
                    '33662057',
                    '33677235',
                    '33677218',
                    '33677214',
                    '33677212',
                    '33677210',
                    '33677209',
                    '33677206',
                    '33677199',
                    '33677192',
                    '33677190',
                    '33677184',
                    '33677182',
                    '33677178',
                    '33677176',
                    '33677173',
                    '33677172',
                    '33677169',
                    '33677168',
                    '33677164',
                    '33677162',
                    '33677156',
                    '33677151',
                    '33677229',
                    '33677148',
                    '33677147',
                    '33677145',
                    '33652665',
                    '33665331',
                    '33497851',
                    '33668098',
                    '33682279',
                    '33669408',
                    '33680696',
                    '33683301',
                    '33683053',
                    '33683372',
                    '33587465',
                    '33685024',
                    '33685026',
                    '33685111',
                    '33687486',
                    '33684127',
                    '33685199',
                    '33685541',
                    '33685566',
                    '33686941',
                    '33684273',
                    '33685615',
                    '33687789',
                    '33687858',
                    '33687277',
                    '33687028',
                    '33687414',
                    '33687788',
                    '33687822',
                    '33685808',
                    '33688456',
                    '33695596',
                    '33695585',
                    '33695578',
                    '33695563',
                    '33683373',
                    '33690150',
                    '33690256',
                    '33691786',
                    '33692403',
                    '33692919',
                    '33690647',
                    '33690440',
                    '33690448',
                    '33691385',
                    '33692314',
                    '33690217',
                    '33691957',
                    '33689761',
                    '33690743',
                    '33567531',
                    '33652667',
                    '33619980',
                    '33620155',
                    '33620957',
                    '33621103',
                    '33621813',
                    '33623933',
                    '33625993',
                    '33688012',
                    '33688015',
                    '33688018',
                    '33702458',
                    '33702463',
                    '33700394',
                    '33693735',
                    '33698605',
                    '33699853',
                    '33700095',
                    '33700229',
                    '33698271',
                    '33698763',
                    '33699438',
                    '33694501',
                    '33700267',
                    '33620156',
                    '33658711',
                    '33700787',
                    '33702760',
                    '33702856',
                    '33703709',
                    '33702833',
                    '33704166',
                    '33704592',
                    '33702401',
                    '33704222',
                    '33700737',
                    '33703009',
                    '33704514',
                    '33701760',
                    '33700500',
                    '33700501',
                    '33700506',
                    '33701713',
                    '33709523',
                    '33709522',
                    '33709520',
                    '33709511',
                    '33709533',
                    '33709510',
                    '33706371',
                    '33706047',
                    '33706563',
                    '33705037',
                    '33706096',
                    '33706260',
                    '33706130',
                    '33706540',
                    '33705299',
                    '33706530',
                    '33706667',
                    '33706557',
                    '33706597',
                    '33706850',
                    '33705040',
                    '33705217',
                    '33705375',
                    '33705512',
                    '33705569',
                    '33649030',
                    '33705597',
                    '33633211',
                    '33688013',
                    '33702462',
                    '33702465',
                    '33713411',
                    '33713482',
                    '33713500',
                    '33713780',
                    '33715094',
                    '33715396',
                    '33714772',
                    '33715380',
                    '33707625',
                    '33713636',
                    '33714451',
                    '33714091',
                    '33718687',
                    '33719503',
                    '33715907',
                    '33718450',
                    '33719244',
                    '33719269',
                    '33715606',
                    '33719434',
                    '33717686',
                    '33719304',
                    '33716410',
                    '33717594',
                    '33715888',
                    '33716394',
                    '33719334',
                    '33706467',
                    '33715075',
                    '33725478',
                    '33725455',
                    '33725447',
                    '33725445',
                    '33725451',
                    '33721455',
                    '33721803',
                    '33721857',
                    '33722336',
                    '33721815',
                    '33719911',
                    '33720757',
                    '33720429',
                    '33721975',
                    '33722387',
                    '33720426',
                    '33721389',
                    '33719762',
                    '33719893',
                    '33719950',
                    '33720106',
                    '33720111',
                    '33720528',
                    '33722136',
                    '33719782',
                    '33611494',
                    '33715371',
                    '33715373',
                    '33715375',
                    '33636896',
                    '33653484',
                    '33653520',
                    '33654743',
                    '33653762',
                    '33653891',
                    '33653786',
                    '33654166',
                    '33654157',
                    '33654634',
                    '33654309',
                    '33654512',
                    '33654682',
                    '33656253',
                    '33657245',
                    '33729207',
                    '33730671',
                    '33725414',
                    '33729697',
                    '33730411',
                    '33722689',
                    '33725130',
                    '33729210',
                    '33516605',
                    '33715982',
                    '33730290',
                    '33732578',
                    '33734302',
                    '33731274',
                    '33732234',
                    '33732626',
                    '33732842',
                    '33731226',
                    '33731376',
                    '33732173',
                    '33732494',
                    '33734406',
                    '33732456',
                    '33733680',
                    '33734399',
                    '33731347',
                    '33732400',
                    '33732554',
                    '33734495',
                    '33740693',
                    '33740626',
                    '33740527',
                    '33740515',
                    '33740501',
                    '33740481',
                    '33740472',
                    '33740413',
                    '33740393',
                    '33740362',
                    '33740342',
                    '33740288',
                    '33734914',
                    '33735132',
                    '33736413',
                    '33736427',
                    '33737118',
                    '33737122',
                    '33734998',
                    '33736033',
                    '33736169',
                    '33736513',
                    '33736891',
                    '33529519',
                    '33529945',
                    '33530238',
                    '33536478',
                    '33542707',
                    '33545148',
                    '33701213',
                    '33701247',
                    '33701750',
                    '33704598',
                    '33704789',
                    '33732594',
                    '33734636',
                    '33744740',
                    '33745894',
                    '33737460',
                    '33744726',
                    '33745396',
                    '33746331',
                    '33744459',
                    '33744569',
                    '33746155',
                    '33746256',
                    '33737506',
                    '33744595',
                    '33744776',
                    '33744907',
                    '33737700',
                    '33737780',
                    '33745380',
                    '33737426',
                    '33731168',
                    '33746985',
                    '33750075',
                    '33747060',
                    '33749969',
                    '33746517',
                    '33749540',
                    '33749221',
                    '33749532',
                    '33749820',
                    '33749902',
                    '33748372',
                    '33750092',
                    '33749372',
                    '33749825',
                    '33750497',
                    '33747188',
                    '33747700',
                    '33749745',
                    '33751240',
                    '33752540',
                    '33750813',
                    '33750933',
                    '33750940',
                    '33751195',
                    '33752667',
                    '33752389',
                    '33750867',
                    '33751086',
                    '33752023',
                    '33619892',
                    '33620005',
                    '33621335',
                    '33622625',
                    '33753231',
                    '33756270',
                    '33753132',
                    '33753274',
                    '33753276',
            );

            // <-------------------------------------------------------------------------

            $this->rcptcancelRun($arrOseq, $userId);

            $end = microtime(true);

echo ($end - $start);

            $exitCode = 0; // 正常終了
$this->logger->info('_data_patch_20180502_1000_DoubleReceiptPatch.php end');

        } catch( \Exception $e ) {
            // エラーログを出力
            if ( isset($this->logger) ) {
$this->logger->err('<DoubleReceiptPatch> ' . $e->getMessage());
$this->logger->err('<DoubleReceiptPatch> ' . $e->getTraceAsString());
            }
        }

        // 終了コードを指定して処理終了
        exit($exitCode);

    }

    /**
     * 入金取消メイン処理
     */
    private function rcptcancelRun($arrOseq, $userId) {

        $mdlo = new TableOrder($this->dbAdapter);

        // [一括コミット]とする
$this->dbAdapter->getDriver()->getConnection()->beginTransaction();

        // 注文SEQのリストを１件ずつ入金取消し
        foreach($arrOseq as $key) {
            // 入力チェック
            if ($this->isReceiptCancel($key) == false) {
                continue;
            }

            // 入金取消しを行う
            $this->rcptcancelAction($key, $userId);

            $this->logger->info('[DoubleReceipt]' . "\t" . $key . "\t" . 'complete!!');

        }

$this->dbAdapter->getDriver()->getConnection()->commit();

    }

    /**
     * 入金取消し可能か否か
     * @param unknown $key
     * @param unknown $value
     * @return boolean
     */
    public function isReceiptCancel($key) {

        $mdlo = new TableOrder($this->dbAdapter);

        // 注文SEQが存在すること
        $row = $mdlo->find($key)->current();
        if (!$row) {
            // データが取得出来ない場合
            $this->logger->alert('[DoubleReceipt]' . "\t" . $key . "\t" . 'OrderSeq Is Not Found');
            return false;
        }

        // キャンセルされていないこと
        if ($mdlo->isCanceled($key)) {
            $this->logger->alert('[DoubleReceipt]' . "\t" . $key . "\t" . 'Is Cancel');
            return false;
        }

        // 一部入金もしくは、入金クローズではない
        if ( !(($row['DataStatus'] == 61) || ($row['DataStatus'] == 91 && $row['CloseReason'] == 1)) ) {
            $this->logger->alert('[DoubleReceipt]' . "\t" . $key . "\t" . 'DataStatus Is InValid[DataStatus=' . $row['DataStatus'] . ',CloseReason=' . $row['CloseReason'] . ']');
            return false;
        }


        // 返金されていないこと
        $sql = ' SELECT COUNT(1) AS CNT FROM T_ClaimControl cc,T_RepaymentControl rc WHERE cc.ClaimId = rc.ClaimId AND cc.OrderSeq = :OrderSeq AND rc.RepayStatus IN (0, 1) ';
        $row = $this->dbAdapter->query($sql)->execute(array(':OrderSeq' => $key))->current();
        $cnt = (int)$row['CNT'];
        if ($cnt > 0) {
            // 返金済み
            $this->logger->alert('[DoubleReceipt]' . "\t" . $key . "\t" . 'Is Repayment Input');
            return false;
        }

        // 手動の雑損失、雑収入がないこと
        $sql = ' SELECT COUNT(1) AS CNT FROM T_SundryControl sc WHERE sc.OrderSeq = :OrderSeq AND sc.SundryClass <> 99 ';
        $row = $this->dbAdapter->query($sql)->execute(array(':OrderSeq' => $key))->current();
        $cnt = (int)$row['CNT'];
        if ($cnt > 0) {
            // 雑損失または雑収入の入力あり
            $this->logger->alert('[DoubleReceipt]' . "\t" . $key . "\t" . 'Is Sundry Input');
            return false;
        }

        return true;
    }

    /**
     * (ajax)入金取消処理
     */
    public function rcptcancelAction($oseq, $userId)
    {
        // $params = $this->getParams();

        // $oseq = isset($params['oseq']) ? $params['oseq'] : 0;

        // 更新処理を行う。
        // $this->dbAdapter->getDriver()->getConnection()->beginTransaction();
        try {
            // ユーザーIDの取得
            // $obj = new \models\Table\TableUser($this->dbAdapter);
            // $userId = $obj->getUserId(0, $this->app->authManagerAdmin->getUserInfo()->OpId);

            // -------------------------
            // エラーチェック
            // -------------------------
            // 注文データを取得
            $sql = "SELECT COUNT(*) AS cnt FROM T_Order WHERE OrderSeq = :OrderSeq AND Cnl_Status = 0";
            $cnt = $this->dbAdapter->query($sql)->execute(array(':OrderSeq' => $oseq))->current()['cnt'];
            // 未キャンセル以外の場合エラー（未キャンセルのデータが存在していれば処理が流れる）
            if ($cnt == 0) {
                $msg = 'キャンセル申請中、もしくはキャンセル済みの注文のため、取消できません。';
                // ロールバック
                // $this->dbAdapter->getDriver()->getConnection()->rollback();
            } else {
                // -------------------------
                // 入金データを取得
                // -------------------------
                $mdlrc = new TableReceiptControl($this->dbAdapter);

                // 直近の1件を取得(登録日で降順ソートしたLIMIT1を取得)
                $data = $this->dbAdapter->query("SELECT * FROM T_ReceiptControl WHERE OrderSeq = :OrderSeq ORDER BY RegistDate DESC LIMIT 1")->execute(array(':OrderSeq' => $oseq))->current();

                // 注文Seqでｻﾏﾘして金額項目を取得
                $sql = <<<EOQ
SELECT  OrderSeq
    ,   SUM(ReceiptAmount) AS ReceiptAmount
    ,   SUM(CheckingUseAmount) AS CheckingUseAmount
    ,   SUM(CheckingClaimFee) AS CheckingClaimFee
    ,   SUM(CheckingDamageInterestAmount) AS CheckingDamageInterestAmount
    ,   SUM(CheckingAdditionalClaimFee) AS CheckingAdditionalClaimFee
FROM    T_ReceiptControl
WHERE   OrderSeq = :OrderSeq
GROUP BY
        OrderSeq
;
EOQ;

                $amountData = $this->dbAdapter->query($sql)->execute(array(':OrderSeq' => $oseq))->current();

                // 金額項目のみ -1 を掛け、入金処理日はシステム日時。
                $amount = array(
                        'ReceiptProcessDate' => date('Y-m-d H:i:s'),
                        'ReceiptAmount' => $amountData['ReceiptAmount'] * -1,
                        'CheckingUseAmount' => $amountData['CheckingUseAmount'] * -1,
                        'CheckingClaimFee' => $amountData['CheckingClaimFee'] * -1,
                        'CheckingDamageInterestAmount' => $amountData['CheckingDamageInterestAmount'] * -1,
                        'CheckingAdditionalClaimFee' => $amountData['CheckingAdditionalClaimFee'] * -1,
                        'RegistId' => $userId,
                        'UpdateId' => $userId,
                );
                // 取得データに金額項目をマージして新規登録
                $rcptSeq = $mdlrc->saveNew(array_merge($data, $amount));        // 2015/11/16 Y.Suzuki 会計対応 Mod

                // 2015/11/16 Y.Suzuki Add 会計対応 Stt
                $mdlatrc = new ATableReceiptControl($this->dbAdapter);
                // 入金取消した会計用のデータを取得
                $atdata = $mdlatrc->find($data['ReceiptSeq'])->current();

                // 2016/01/05 Y.Suzuki Add 入金取消前のデータを取得 Stt
                // 入金取消前立替クリアフラグ、入金取消前立替クリア日
                $sql = "SELECT ClearConditionForCharge, ClearConditionDate FROM T_PayingAndSales WHERE OrderSeq = :OrderSeq";
                $ri = $this->dbAdapter->query($sql)->execute(array(':OrderSeq' => $oseq));
                $clearConditionForCharge = $ri->current()['ClearConditionForCharge'];
                $clearConditionDate = $ri->current()['ClearConditionDate'];
                // 入金取消前立替処理－ステータス、入金取消前配送－着荷確認
                $sql = "SELECT Cnl_Status, Deli_ConfirmArrivalFlg FROM T_Order WHERE OrderSeq = :OrderSeq";
                $ri = $this->dbAdapter->query($sql)->execute(array(':OrderSeq' => $oseq));
                $cnlStatus = $ri->current()['Cnl_Status'];
                $deliConfirmArrivalFlg = $ri->current()['Deli_ConfirmArrivalFlg'];
                $candata = array(
                        'ReceiptSeq' => $rcptSeq,
                        'Rct_CancelFlg' => 1,
                        'Before_ClearConditionForCharge' => $clearConditionForCharge,
                        'Before_ClearConditionDate' => $clearConditionDate,
                        'Before_Cnl_Status' => $cnlStatus,
                        'Before_Deli_ConfirmArrivalFlg' => $deliConfirmArrivalFlg
                );
                // 2016/01/05 Y.Suzuki Add 入金取消前のデータを取得 End

                // 取得データに入金管理Seqをマージして新規登録
                $mdlatrc->saveNew(array_merge($atdata, $candata));      // 2016/01/05 Y.Suzuki 会計関連_入金取消対応 Mod
                // 2015/11/16 Y.Suzuki Add 会計対応 End

                // -------------------------
                // 雑損失データを取得
                // -------------------------
                $mdlsc = new TableSundryControl($this->dbAdapter);

                // 会計対象外データを取得
                // 直近の1件を取得(登録日で降順ソートしたLIMIT1を取得)
                $sql = "SELECT * FROM T_SundryControl WHERE SundryType = 1 AND SundryClass = 99 AND OrderSeq = :OrderSeq ORDER BY RegistDate DESC LIMIT 1";
                $data = $this->dbAdapter->query($sql)->execute(array(':OrderSeq' => $oseq))->current();

                // データが取得出来た場合のみ、以下処理を行う。
                if (! empty($data)) {
                    // 注文Seqでｻﾏﾘして金額項目を取得
                    $sql = <<<EOQ
SELECT  OrderSeq
    ,   SUM(SundryAmount) AS SundryAmount
    ,   SUM(CheckingUseAmount) AS CheckingUseAmount
    ,   SUM(CheckingClaimFee) AS CheckingClaimFee
    ,   SUM(CheckingDamageInterestAmount) AS CheckingDamageInterestAmount
    ,   SUM(CheckingAdditionalClaimFee) AS CheckingAdditionalClaimFee
FROM    T_SundryControl
WHERE   SundryType = 1
AND     SundryClass = 99
AND     OrderSeq = :OrderSeq
GROUP BY
        OrderSeq
;
EOQ;

                    $amountData = $this->dbAdapter->query($sql)->execute(array(':OrderSeq' => $oseq))->current();

                    // 取得データのSundryAmount が 0 の場合は処理しない
                    if ($amountData['SundryAmount'] > 0) {
                        // 金額項目のみ -1 を掛け、発生日はシステム日時
                        $amount = array(
                                'ProcessDate' => date('Y-m-d H:i:s'),
                                'SundryAmount' => $amountData['SundryAmount'] * -1,
                                'CheckingUseAmount' => $amountData['CheckingUseAmount'] * -1,
                                'CheckingClaimFee' => $amountData['CheckingClaimFee'] * -1,
                                'CheckingDamageInterestAmount' => $amountData['CheckingDamageInterestAmount'] * -1,
                                'CheckingAdditionalClaimFee' => $amountData['CheckingAdditionalClaimFee'] * -1,
                                'RegistId' => $userId,
                                'UpdateId' => $userId,
                        );
                        // 取得データに金額項目をマージして新規登録
                        $mdlsc->saveNew(array_merge($data, $amount));
                    }
                }

                // 会計対象データを取得
                // 直近の1件を取得(登録日で降順ソートしたLIMIT1を取得)
                $sql = "SELECT * FROM T_SundryControl WHERE SundryType = 1 AND SundryClass <> 99 AND OrderSeq = :OrderSeq ORDER BY RegistDate DESC LIMIT 1";
                $data = $this->dbAdapter->query($sql)->execute(array(':OrderSeq' => $oseq))->current();

                // データが取得できた場合のみ、以下処理を行う。
                if (! empty($data)) {
                    // 注文Seqでｻﾏﾘして金額項目を取得
                    $sql = <<<EOQ
SELECT  OrderSeq
    ,   SUM(SundryAmount) AS SundryAmount
    ,   SUM(CheckingUseAmount) AS CheckingUseAmount
    ,   SUM(CheckingClaimFee) AS CheckingClaimFee
    ,   SUM(CheckingDamageInterestAmount) AS CheckingDamageInterestAmount
    ,   SUM(CheckingAdditionalClaimFee) AS CheckingAdditionalClaimFee
FROM    T_SundryControl
WHERE   SundryType = 1
AND     SundryClass <> 99
AND     OrderSeq = :OrderSeq
GROUP BY
        OrderSeq
;
EOQ;

                    $amountData = $this->dbAdapter->query($sql)->execute(array(':OrderSeq' => $oseq))->current();

                    // 取得データのSundryAmount が 0 の場合は処理しない
                    if ($amountData['SundryAmount'] > 0) {
                        // 金額項目のみ -1 を掛け、発生日はシステム日時
                        $amount = array(
                                'ProcessDate' => date('Y-m-d H:i:s'),
                                'SundryAmount' => $amountData['SundryAmount'] * -1,
                                'CheckingUseAmount' => $amountData['CheckingUseAmount'] * -1,
                                'CheckingClaimFee' => $amountData['CheckingClaimFee'] * -1,
                                'CheckingDamageInterestAmount' => $amountData['CheckingDamageInterestAmount'] * -1,
                                'CheckingAdditionalClaimFee' => $amountData['CheckingAdditionalClaimFee'] * -1,
                                'RegistId' => $userId,
                                'UpdateId' => $userId,
                        );
                        // 取得データに金額項目をマージして新規登録
                        $mdlsc->saveNew(array_merge($data, $amount));
                    }
                }

                // -------------------------
                // 雑収入データを取得
                // -------------------------
                // 直近の1件を取得(登録日で降順ソートしたLIMIT1を取得)
                $sql = "SELECT * FROM T_SundryControl WHERE SundryType = 0 AND OrderSeq = :OrderSeq ORDER BY RegistDate DESC LIMIT 1";
                $data = $this->dbAdapter->query($sql)->execute(array(':OrderSeq' => $oseq))->current();

                // データが取得できた場合のみ、以下処理を行う。
                if (! empty($data)) {
                    // 注文Seqでｻﾏﾘして金額項目を取得
                    $sql = <<<EOQ
SELECT  OrderSeq
    ,   SUM(SundryAmount) AS SundryAmount
    ,   SUM(CheckingUseAmount) AS CheckingUseAmount
    ,   SUM(CheckingClaimFee) AS CheckingClaimFee
    ,   SUM(CheckingDamageInterestAmount) AS CheckingDamageInterestAmount
    ,   SUM(CheckingAdditionalClaimFee) AS CheckingAdditionalClaimFee
FROM    T_SundryControl
WHERE   SundryType = 0
AND     OrderSeq = :OrderSeq
GROUP BY
        OrderSeq
;
EOQ;

                    $amountData = $this->dbAdapter->query($sql)->execute(array(':OrderSeq' => $oseq))->current();

                    // 取得データのSundryAmount が 0 の場合は処理しない
                    if ($amountData['SundryAmount'] > 0) {
                        // 金額項目のみ -1 を掛け、発生日はシステム日時
                        $amount = array(
                                'ProcessDate' => date('Y-m-d H:i:s'),
                                'SundryAmount' => $amountData['SundryAmount'] * -1,
                                'CheckingUseAmount' => $amountData['CheckingUseAmount'] * -1,
                                'CheckingClaimFee' => $amountData['CheckingClaimFee'] * -1,
                                'CheckingDamageInterestAmount' => $amountData['CheckingDamageInterestAmount'] * -1,
                                'CheckingAdditionalClaimFee' => $amountData['CheckingAdditionalClaimFee'] * -1,
                                'RegistId' => $userId,
                                'UpdateId' => $userId,
                        );
                        // 取得データに金額項目をマージして新規登録
                        $mdlsc->saveNew(array_merge($data, $amount));
                    }
                }

                // -------------------------
                // 印紙代データを取得
                // -------------------------
                // 直近の1件を取得(登録日で降順ソートしたLIMIT1を取得)
                $sql = "SELECT * FROM T_StampFee WHERE OrderSeq = :OrderSeq ORDER BY RegistDate DESC LIMIT 1";
                $data = $this->dbAdapter->query($sql)->execute(array(':OrderSeq' => $oseq))->current();

                // データが取得できた場合のみ、以下処理を行う。
                if (! empty($data)) {
                    // 注文Seqでｻﾏﾘして金額項目を取得
                    $sql = "SELECT OrderSeq , SUM(StampFee) AS StampFee FROM T_StampFee WHERE OrderSeq = :OrderSeq GROUP BY OrderSeq";
                    $amountData = $this->dbAdapter->query($sql)->execute(array(':OrderSeq' => $oseq))->current();

                    // 取得データのStampFee が 0 の場合は処理しない
                    if ($amountData['StampFee'] > 0) {
                        // 金額項目のみ -1 を掛け、発生確定日はシステム日時
                        $amount = array(
                                'DecisionDate' => date('Y-m-d H:i:s'),
                                'StampFee' => $amountData['StampFee'] * -1,
                                'RegistId' => $userId,
                                'UpdateId' => $userId,
                        );
                        // 取得データに金額項目をマージして新規登録
                        $mdlsf = new TableStampFee($this->dbAdapter);
                        $mdlsf->saveNew(array_merge($data, $amount));
                    }
                }

                // 注文データを更新
                $mdlo = new TableOrder($this->dbAdapter);
                $mdlo->saveUpdateWhere(array('DataStatus' => 61, 'CloseReason' => 0, 'UpdateId' => $userId), array('P_OrderSeq' => $oseq));

                // 注文データを取得
                $orderData = ResultInterfaceToArray($mdlo->findOrder(array('P_OrderSeq' => $oseq)));

                // 取得件数分、ループする
                foreach ($orderData as $key => $value) {
                    // 立替・売上管理データを取得
                    $mdlpas = new TablePayingAndSales($this->dbAdapter);
                    $pasData = $this->dbAdapter->query("SELECT * FROM T_PayingAndSales WHERE OrderSeq = :OrderSeq")->execute(array(':OrderSeq' => $value['OrderSeq']))->current();

                    // 立替クリアフラグが上がっており、未立替　かつ　着荷確認済みでない　場合は、立替クリアフラグを落とす
                    if ($pasData['ClearConditionForCharge'] == 1 && $pasData['PayingControlStatus'] == 0 && $value['Deli_ConfirmArrivalFlg'] <> 1) {
                        // 立替・売上管理データを更新
                        $mdlpas->saveUpdate(array('ClearConditionForCharge' => 0, 'ClearConditionDate' => null, 'UpdateId' => $userId), $pasData['Seq']);

                        // 立替・売上管理_会計更新(売上ﾀｲﾌﾟ、売上日の初期化)
                        $row_pas = $this->dbAdapter->query(" SELECT Seq FROM T_PayingAndSales WHERE OrderSeq = :OrderSeq ")->execute(array(':OrderSeq' => $value['OrderSeq']))->current();
                        $mdlapas = new \models\Table\ATablePayingAndSales($this->dbAdapter);
                        $mdlapas->saveUpdate(array('ATUriType' => 99, 'ATUriDay' => '99999999'), $row_pas['Seq']);
                    }
                }

                // 請求管理更新
                // 請求額 = 請求残高へ更新する。
                $sql = <<<EOQ
UPDATE  T_ClaimControl
SET     ClaimedBalance = ClaimAmount
    ,   ReceiptAmountTotal = 0
    ,   SundryLossTotal = 0
    ,   SundryIncomeTotal = 0
    ,   CheckingClaimAmount = 0
    ,   CheckingUseAmount = 0
    ,   CheckingClaimFee = 0
    ,   CheckingDamageInterestAmount = 0
    ,   CheckingAdditionalClaimFee = 0
    ,   BalanceClaimAmount = ClaimAmount
    ,   BalanceUseAmount = UseAmountTotal
    ,   BalanceClaimFee = ClaimFee
    ,   BalanceDamageInterestAmount = DamageInterestAmount
    ,   BalanceAdditionalClaimFee = AdditionalClaimFee
    ,   UpdateDate = :UpdateDate
    ,   UpdateId = :UpdateId
    ,   LastReceiptSeq = :LastReceiptSeq
WHERE   OrderSeq = :OrderSeq
;
EOQ;

                // 更新実行
                $this->dbAdapter->query($sql)->execute(array(':OrderSeq' => $oseq, ':UpdateId' => $userId, ':UpdateDate' => date('Y-m-d H:i:s'), ':LastReceiptSeq' => $rcptSeq));

                // 停滞アラートを更新
                $mdlsa = new TableStagnationAlert($this->dbAdapter);
                $mdlsa->saveUpdateWhere(array('AlertSign' => 0, 'UpdateId' => $userId), array('OrderSeq' => $oseq));

                try
                {
                    // 入金未確認ﾒｰﾙを送信する。
                    // 詳細が決定するまで保留。
                }
                catch(\Exception $e) {  }

                // 注文履歴登録用に親注文Seqから子注文Seqを再取得する。
                $sql = <<<EOQ
SELECT  OrderSeq
FROM    T_Order
WHERE   P_OrderSeq = :P_OrderSeq
AND     Cnl_Status = 0
;
EOQ;

                $ri = $this->dbAdapter->query($sql)->execute(array(':P_OrderSeq' => $oseq));
                $rows = ResultInterfaceToArray($ri);

                // 注文履歴へ登録
                $history = new CoralHistoryOrder($this->dbAdapter);
                // 親注文Seqに紐づく子注文分、ループする。
                foreach ($rows as $row) {
                    // 注文履歴登録
                    $history->InsOrderHistory($row['OrderSeq'], 65, $userId);
                }

                // コミット
                // $this->dbAdapter->getDriver()->getConnection()->commit();
                // 成功指示
                $msg = '1';
            }
        } catch (\Exception $e) {
            throw $e;
            // ロールバック
            // $this->dbAdapter->getDriver()->getConnection()->rollback();
            // エラー内容吐き出し
            // $msg = $e->getMessage();
        }

//         echo \Zend\Json\Json::encode(array('status' => $msg));
//         return $this->response;
    }

}

Application::getInstance()->run();
