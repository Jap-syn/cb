<?php
chdir(dirname(__DIR__));

// Setup autoloading
require 'init_autoloader.php';

setlocale( LC_ALL, 'ja_JP.UTF-8' );
ini_set( 'default_charset', 'UTF-8' );
mb_internal_encoding( 'UTF-8' );
mb_http_output('UTF-8');
mb_regex_encoding( 'UTF-8' );

ini_set( 'max_execution_time', 0 );

use Coral\Base\Application\BaseApplicationAbstract;
use Coral\Base\BaseLog;
use Coral\Base\IO\BaseIOUtility;
use Zend\Config\Reader\Ini;
use Zend\Db\Adapter\Adapter;
use Zend\Db\Adapter\Driver\ResultInterface;
use Zend\Db\ResultSet\ResultSet;
use Zend\Http\Client;
use Zend\Json\Json;
use models\Logic\CreditJudge\LogicCreditJudgeOptions;
use models\Logic\CreditJudge\Connector\LogicCreditJudgeConnectorIlu;
use models\Table\TableCjOrderIdControl;
use models\Table\TableManagementCustomer;
use models\Table\TableUser;

/**
 * 与信審査依頼連携を行います
 *
 */
class Application extends BaseApplicationAbstract {
    protected $_application_id = 'tools-trans_iludata-batch';

    /**
     * Application の唯一のインスタンスを取得します。
     *
     * @static
     * @access public
     * @return Application
     */
    public static function getInstance() {
        if( self::$_instance === null ) {
            self::$_instance = new self();
        }

        return self::$_instance;
    }

    /**
     * Application の新しいインスタンスを初期化します。
     *
     * @ignore
     * @access private
     */
    private function __construct() {
        parent::init();
    }

    /**
     * @var Adapter
     */
    private $dbAdapter;

    /**
     * ログクラス
     *
     * @var BaseLog
     */
    private $logger;

    /**
     * 設定データ
     *
     * @access private
     * @var array
     */
    private $configs;

    /**
     * ユーザーID
     *
     * @var int
     */
    private $userId;

    /**
     * ILUコネクタ
     *
     * @access private
     * @var LogicCreditJudgeConnectorIlu
     */
    private $connector;

    /**
     * 審査システムから受信した展開済みデータ
     *
     * @access private
     * @param array
     */
    private $received_data;
    /**
     * 審査システムから受信したデータを取得する
     *
     * @return array
     */
    private function getReceivedData() {
        return $this->received_data;
    }
    /**
     * 審査システムから受信したXMを展開したLデータをセットする
     *
     * @param array $data 受信したXMLを展開したデータ
     */
    private function setReceivedData($data) {
        $this->received_data = $data;
    }

    /**
     * 送信に使用したXMLデータを取得する
     *
     * @return string
     */
    public function getSentXml($format = false) {
        if(!$format) return $this->connector->getSentData();
        $dom = new \DOMDocument('1.0', 'utf-8');
        $dom->loadXML($this->connector->getSentData());
        $dom->formatOutput = true;
        return $dom->saveXML();
    }

    /**
     * 受信したXMLデータを取得する
     *
     * @return string
     */
    public function getReceivedXml() {
        return $this->connector->getReceivedData();
    }

    /**
     * 受付番号
     * @var int
     */
    private $receipt_no;

    /**
     * コマンドラインのパラメータ
     */
    private static $_argv;
    public static function setArgv($arg) {
        self::$_argv = $arg;
    }

    /**
     * アプリケーションを実行します。
     *
     * @access public
     */
    public function run() {
        $exitCode = 1;

        try {
            // iniファイルから設定を取得
            $configPath = __DIR__ . '/../module/cbadmin/config/config.ini';

            // データベースアダプタをiniファイルから初期化します
            $data = array();
            if (file_exists($configPath))
            {
                $reader = new Ini();
                $data = $reader->fromFile($configPath);
            }
            $this->dbAdapter = new Adapter($data['database']);

            // ログ設定の読み込み
            $logConfig = $data['log'];
            // 標準ログクラス初期化
            $this->logger = BaseLog::createFromArray( $logConfig );

            $start = microtime(true);
$this->logger->info('trans_iludata_01.php start');

            $globalConfig = include __DIR__ . '/../config/autoload/global.php';
            // 接続時間を設定する
            $rds_session_timezone = $globalConfig['RDS_SESSION_TIMEZONE'];
            if (isset($rds_session_timezone)) {
                $this->dbAdapter->query('SET SESSION time_zone = :time_zone')->execute(array(':time_zone'=>$rds_session_timezone));
            }

            // 設定をシステムプロパティテーブルから読み込み
            $apinfo = $this->getApplicationiInfo($this->dbAdapter, 'cbadmin');
            // iniファイルの内容をマージ
            $data = array_merge($data, $apinfo);

            $this->configs = $data;

            // ユーザーID取得
            $mdlu = new TableUser($this->dbAdapter);
            $this->userId = $mdlu->getUserId(TableUser::USERCLASS_SYSTEM, TableUser::SEQ_BATCH_USER);

            // 審査システムデータ移行処理
            $this->_exec();

$this->logger->info('trans_iludata_01.php end');
$this->logger->info(sprintf('trans_iludata_01.php elapsed time = %s', (microtime(true) - $start)));

            $exitCode = 0; // 正常終了

        } catch( \Exception $e ) {
            // エラーログを出力
            if ( isset($this->logger) ) {
$this->logger->err($e->getMessage());
            }
        }

        // 終了コードを指定して処理終了
        exit($exitCode);

    }


    /**
     * 審査システムデータ移行処理
     *  TODO sode 各処理を別バッチとする
     */
    private function _exec() {

        // 与信審査依頼連携
        $this->CreditInspection();
/*
        // 支払情報連携
        $this->SetPaymentData();

        // 顧客情報登録・編集連携
        $this->CustomerListImport();

        // 一定時間待機
        $sec = 10;    // 秒
        // パラメータで指定した秒数だけ待つ
        if (isset(self::$_argv[1]) && is_numeric(self::$_argv[1])) {
            $sec = (int)self::$_argv[1];
        }
        usleep($sec * 1000000);

        // 顧客情報編集結果取得
        $this->GetCustomerListImportResult();
*/
    }

    /**
     * 与信審査依頼
     */
    private function CreditInspection() {

        $start = microtime(true);
$this->logger->info('CreditInspection start');

        // 移行対象注文取得
//sode 修正　移行対象データ範囲の見直し
        $sql = <<<EOQ
/*
SELECT o.OrderSeq
  FROM T_Order o
       LEFT OUTER JOIN T_CjOrderIdControl cj ON o.OrderSeq = cj.OrderSeq
 WHERE o.DataStatus <= 61
   AND IFNULL(o.OutOfAmends, 0) <> 1
   AND cj.OrderSeq IS NULL
 ORDER BY o.OrderSeq
*/

SELECT o.OrderSeq
  FROM T_Order o
	   LEFT OUTER JOIN T_ClaimControl cc on o.P_OrderSeq = cc.OrderSeq
 WHERE o.DataStatus in (61, 51)
   AND IFNULL(o.OutOfAmends, 0) <> 1
   AND (cc.F_LimitDate >= '2014-02-20')
   AND o.RegistDate < '2015-12-01 03:00:00'

UNION ALL
SELECT o.OrderSeq
  FROM T_Order o
 WHERE o.DataStatus < 51
   AND IFNULL(o.OutOfAmends, 0) <> 1
   AND o.OrderSeq in 
(
22463255,22586384,22603062,22655221,22729490,22733574,22742909,22825750,23044832,23072901,23081000,23165019,23190115,23224847,23274885,23280102,23292042,20325833,20328002,20330001,20338224,20341792,20341795,20341804,20341821,20341824,20341841,20341846,20341851,20348603,20349498,20353069,20356267,20356514,20357695,20360570,20365100,20365182,20366351,20367033,20368817,20369357,20376363,20377149,20377173,20377198,20383134,20383460,20383509,20383511,20385076,20385636,20389097,20389174,20389521,20389577,20389837,20389916,20392655,20393002,20393130,20403498,20404167,20405509,20405523,20405789,20406032,20406036,20408607,20409632,20409693,20409775,20410183,20410648,20411452,20422906,20425603,20426584,20429173,20430778,20431754,20432098,20432838,20435165,20435692,20436763,20437007,20437064,20437069,20437847,20442029,20447071,20447114,20447239,20447285,20447451,20448485,20448518,20448658,20451283,20451368,20452265,20453967,20454333,20454407,20457675,20457862,20458112,20458751,20458778,20459977,20460315,20460324,20460954,20461426,20462526,20463272,20466323,20466674,20467484,20467591,20468034,20468050,20468080,20469536,20469687,20469805,20469902,20470185,20470384,20470609,20471642,20476314,20476695,20476725,20476730,20476732,20476734,20476738,20478835,20479108,20479109,20479262,20479390,20479830,20480567,20481206,20486286,20488166,20488220,20488639,20488868,20489730,20490007,20490548,20490792,20491183,20491233,20491468,20493162,20493312,20494045,20494269,20494735,20495477,20496507,20496629,20496678,20496741,20496998,20499154,20500187,20502358,20502874,20503195,20503234,20503695,20503697,20503731,20503772,20504059,20504409,20504867,20505005,20505057,20505150,20505214,20506747,20507163,20507195,20507517,20507766,20507805,20508149,20508746,20508752,20509275,20509656,20510305,20511539,20513646,20514580,20514617,20515290,20515598,20515606,20515607,20516049,20517878,20517879,20517880,20517881,20517882,20517883,20517884,20517885,20517886,20518016,20518342,20519230,20519665,20519664,20519666,20519667,20519669,20519671,20519672,20519673,20519928,20519951,20521622,20522308,20525887,20527621,20527768,20527846,20527864,20528182,20528500,20530484,20534598,20535429,20536668,20538083,20538145,20541603,20545914,20546410,20546756,20547721,20548137,20548193,20548194,20548285,20550475,20550935,20551084,20551085,20551350,20551574,20553900,20553919,20553968,20553978,20554140,20556667,20557085,20562019,20562274,20562759,20562760,20564152,20564180,20564367,20565180,20565656,20565865,20569128,20569238,20569354,20569870,20573771,20573994,20574196,20576985,20576997,20577003,20577652,20580850,20583262,20583376,20584043,20584064,20584081,20584151,20586844,20587084,20587141,20587143,20587279,20587571,20589532,20589617,20589620,20589653,20589694,20590791,20591740,20592882,20593383,20595010,20595397,20595661,20595733,20598789,20599219,20600010,20601231,20601253,20603830,20605052,20606222,20607090,20608322,20608525,20608911,20609219,20610495,20613104,20618177,20620462,20621974,20630198,20630199,20630200,20630646,20633107,20633131,20633132,20633133,20633134,20633135,20633136,20633137,20633138,20633140,20633141,20633143,20633144,20633145,20633146,20633147,20633148,20633149,20633150,20633166,20633322,20633325,20634126,20636402,20639083,20642707,20642717,20646652,20647101,20650424,20656112,20657680,20659422,20659538,20660736,20660740,20660746,20662216,20665002,20665003,20665004,20665005,20671468,20672501,20672509,20673098,20677275,20679338,20682458,20682468,20682484,20682486,20683488,20689141,20689237,20689683,20694700,20699982,20703099,20705796,20706064,20706108,20706560,20706561,20707353,20710661,20711464,20711566,20712180,20713855,20713862,20714050,20715577,20716403,20716520,20723427,20723581,20723648,20723911,20724034,20724055,20724059,20724834,20724853,20725012,20725529,20726348,20726388,20726466,20726507,20728081,20728866,20728922,20729584,20732754,20735253,20737016,20739118,20743335,20745207,20745770,20745899,20745963,20746001,20746779,20748770,20751695,20752887,20755451,20755455,20757155,20772208,20777914,20777921,20777937,20779581,20779816,20780167,20781103,20781107,20781657,20781786,20781788,20782159,20782976,20783099,20783233,20783335,20783812,20783817,20783818,20783821,20783822,20783823,20783824,20784240,20784298,20784707,20788759,20789734,20790083,20794334,20795330,20796797,20796853,20797765,20800981,20800996,20801151,20801372,20801395,20801603,20801607,20801626,20802077,20802120,20802336,20802507,20802839,20803180,20803703,20804580,20804814,20805094,20805096,20805097,20805098,20805099,20805108,20805225,20805605,20805833,20805914,20805941,20806071,20806245,20806414,20806461,20806953,20806956,20806959,20806960,20806961,20806962,20806964,20806965,20806966,20807930,20814794,20814795,20819635,20821936,20824143,20827251,20827263,20827265,20832816,20836880,20837609,20837745,20838561,20845095,20845126,20850988,20853003,20853004,20858733,20868289,20868319,20872070,20874428,20874485,20874493,20876322,20879056,20881234,20885607,20887292,20887690,20895972,20897672,20901555,20901557,20901576,20901577,20901582,20902716,20902726,20906376,20906925,20911887,20920130,20920251,20923687,20924893,20928326,20928389,20929052,20929065,20929577,20930694,20932128,20940432,20940995,20941588,20943555,20944646,20945442,20946122,20946123,20949381,20951352,20951602,20958339,20960106,20960112,20960120,20960121,20960735,20962178,20963234,20963628,20963629,20964545,20964898,20964923,20965108,20965192,20965204,20971603,20977191,20977596,20977938,20978164,20978309,20981800,20982171,20982471,20983942,20985330,20985511,20985516,20987226,20987243,20988473,20988490,20988503,20988509,20990387,20995613,21000350,21001759,21002980,21004563,21010920,21012454,21019977,21019992,21032683,21038553,21040653,21041342,21042853,21044629,21046869,21046883,21046900,21054759,21054789,21054853,21056067,21059211,21059217,21059220,21059232,21059243,21059593,21059899,21066459,21067062,21068264,21068270,21068284,21068932,21068976,21068982,21069361,21069386,21069607,21069918,21069996,21070432,21070433,21072895,21074550,21074723,21075042,21076385,21076388,21076393,21076396,21079396,21080744,21083646,21083950,21084121,21086974,21087211,21095584,21096433,21099412,21099461,21101376,21101865,21102478,21102736,21104700,21107014,21109115,21112677,21113001,21115676,21115682,21115689,21117499,21118314,21119030,21119337,21121755,21122633,21124583,21130319,21133428,21134126,21136455,21136473,21137998,21138579,21140017,21144036,21144611,21148220,21148649,21148877,21148884,21151407,21154048,21154062,21154084,21154089,21155576,21155578,21155581,21155584,21158321,21159002,21167948,21180532,21199008,21199009,21199010,21199037,21199079,21199104,21199105,21199106,21199107,21199108,21199234,21199236,21199237,21200536,21204094,21204111,21204472,21216523,21228516,21229063,21232231,21233759,21235119,21239993,21240123,21242079,21243238,21245345,21245665,21245900,21247209,21247210,21248865,21262191,21262440,21269373,21270154,21270161,21270175,21270186,21270188,21272375,21274566,21279192,21284711,21285012,21286391,21290701,21298301,21299690,21301161,21303356,21304870,21305450,21307271,21307272,21308186,21308873,21315694,21317686,21321153,21322760,21325635,21327477,21327811,21329047,21330241,21332245,21334858,21336000,21336014,21337024,21343010,21343670,21346189,21347049,21347055,21347057,21347058,21347061,21347718,21350049,21350488,21351510,21352148,21358648,21359563,21359712,21362957,21364595,21369066,21369090,21369738,21374732,21375693,21377819,21382040,21383106,21383275,21386065,21388953,21395277,21398232,21398592,21401528,21403061,21403221,21404863,21407407,21409824,21414022,21420613,21426228,21426231,21426716,21427007,21431956,21434751,21436197,21444281,21444415,21444577,21445128,21446505,21446515,21446529,21446536,21446537,21446542,21453095,21455242,21457304,21458093,21462237,21462404,21462441,21462477,21463982,21468981,21469387,21471152,21473454,21473471,21474631,21474632,21474633,21474634,21474635,21474636,21474638,21474640,21474642,21474643,21474645,21474789,21474790,21474793,21474794,21474796,21476782,21477378,21477790,21477800,21478203,21483560,21486968,21489708,21490149,21493717,21494175,21495617,21495845,21499221,21504941,21504966,21513552,21513619,21520663,21520719,21520735,21520810,21520861,21521304,21524339,21524414,21524441,21527462,21528979,21529060,21529070,21529248,21534054,21539880,21540227,21540232,21540308,21542594,21542609,21544466,21544965,21544972,21548704,21548985,21553255,21554573,21555036,21558533,21559638,21560417,21560563,21568029,21569255,21570059,21570348,21570822,21574149,21574462,21574519,21576972,21578331,21578339,21578489,21584509,21584639,21585343,21587535,21587562,21587977,21589960,21595571,21597968,21599150,21599346,21600062,21602287,21605599,21606039,21606701,21607397,21607491,21607853,21608295,21608591,21610109,21610237,21611045,21611070,21611111,21611505,21611763,21612038,21612147,21612177,21612184,21612256,21612573,21612672,21612711,21612732,21612733,21612798,21612877,21612942,21612970,21612986,21614265,21614287,21615048,21615059,21615065,21615076,21615233,21615331,21615436,21615494,21615959,21616041,21616207,21616346,21616398,21616527,21616713,21617472,21617733,21617940,21620923,21620953,21621334,21621489,21622093,21622096,21622179,21622244,21622360,21622370,21623091,21624832,21626663,21626798,21629178,21638101,21640581,21641320,21641729,21643118,21647120,21649128,21649691,21650621,21650997,21653424,21655946,21661485,21662010,21662337,21662976,21663152,21663770,21664193,21664317,21664765,21664766,21669337,21669338,21671237,21675139,21675243,21676082,21676403,21676559,21676561,21676970,21677968,21677969,21680842,21681121,21681519,21681551,21684796,21684797,21684799,21685544,21685545,21685546,21685548,21685556,21685557,21685558,21685559,21685563,21685564,21685565,21685570,21685571,21685572,21685575,21685576,21685577,21685578,21685579,21685580,21685582,21685583,21685589,21685596,21685597,21685605,21685606,21685607,21685612,21685613,21685614,21685637,21685643,21685651,21685652,21685654,21685689,21685709,21685710,21685721,21685722,21685781,21685783,21685862,21685892,21685893,21685910,21685941,21685942,21685953,21685981,21685986,21685987,21685990,21686046,21686157,21686193,21686216,21686220,21686224,21686225,21686238,21686244,21686247,21686262,21686263,21686339,21686421,21686486,21686526,21686533,21686551,21686565,21686574,21686631,21686673,21686711,21686729,21686781,21686859,21686885,21686917,21686955,21686980,21686985,21687004,21687073,21687147,21687148,21687190,21687196,21687214,21687231,21687233,21687234,21687250,21687278,21687282,21687284,21687307,21687313,21687315,21687327,21687331,21687333,21687372,21687437,21687449,21687462,21687477,21687482,21687483,21687486,21687492,21687504,21687507,21687508,21687521,21687526,21687537,21687542,21687584,21687596,21687640,21687694,21687711,21687748,21687760,21687768,21687770,21687772,21687792,21687796,21687811,21687815,21687895,21687899,21687900,21687931,21687940,21687945,21687951,21687962,21687966,21687975,21687982,21687987,21687988,21687990,21688025,21688056,21688150,21688155,21688162,21688171,21688220,21688232,21688235,21688244,21688279,21688292,21688312,21688623,21688626,21688650,21688658,21688670,21688689,21688719,21688721,21688742,21688776,21689001,21689050,21689262,21689267,21689990,21690284,21690304,21690410,21690416,21690602,21690651,21690692,21690709,21690724,21690759,21690769,21690820,21690829,21690932,21690944,21690956,21691004,21691015,21691024,21691028,21691035,21691079,21691112,21691125,21691171,21691176,21691184,21691187,21691191,21691209,21691213,21691292,21691307,21691312,21691451,21691469,21691474,21691493,21691497,21691516,21691561,21691563,21691580,21691589,21691598,21691604,21691659,21691663,21691679,21692748,21696795,21697826,21698072,21698126,21703290,21707063,21707092,21707097,21707232,21707321,21707332,21711131,21711474,21712052,21712372,21712459,21712630,21712806,21716147,21718989,21719006,21719008,21719017,21722112,21722631,21722755,21732958,21734446,21734597,21734659,21740948,21742612,21744947,21747107,21748788,21750412,21752637,21753647,21756991,21757705,21759235,21759241,21759247,21760594,21761822,21762278,21762423,21762459,21762499,21763257,21763370,21763420,21769310,21769450,21769456,21769479,21777343,21778613,21778702,21786200,21790295,21792323,21794356,21795217,21797095,21797813,21798116,21800089,21800175,21802106,21802398,21804030,21804803,21805546,21805560,21809442,21809724,21812284,21812309,21814215,21814255,21814259,21816696,21818084,21818449,21818498,21820862,21821424,21821749,21821780,21823030,21823491,21823507,21823851,21824145,21826791,21828172,21829368,21836509,21841147,21841736,21841748,21842109,21842171,21845001,21845113,21845130,21846521,21847437,21847440,21847447,21847450,21848468,21851161,21851366,21851653,21852112,21853114,21853550,21858554,21859136,21860135,21860311,21862028,21864268,21864578,21865489,21866225,21873070,21873401,21874395,21874449,21874556,21874628,21874880,21874937,21875270,21875331,21875767,21876579,21877830,21882717,21882805,21883972,21885972,21885973,21886664,21886703,21887352,21889175,21889732,21893074,21894498,21895908,21898403,21899999,21900334,21909104,21910811,21911121,21912679,21913384,21913385,21913386,21917496,21917514,21917575,21917587,21917607,21918002,21918053,21920434,21923167,21925046,21926937,21926983,21926991,21927562,21928123,21928518,21931952,21933156,21934817,21940003,21940393,21946170,21946188,21947354,21951375,21951607,21951634,21952400,21953325,21960149,21960172,21960578,21960956,21961131,21961176,21961430,21962077,21966056,21966240,21967879,21968617,21971875,21972222,21972614,21975016,21976697,21976698,21976922,21979393,21980594,21982119,21984827,21986215,21986404,21986688,21987882,21988513,21989086,21989302,21990625,21992504,21992722,21993843,21995465,21995978,21996274,22001939,22002254,22002352,22002634,22002675,22002825,22003021,22003123,22008662,22008677,22008708,22009844,22010003,22010037,22010104,22011975,22013203,22013205,22014213,22015525,22015526,22015860,22016001,22016239,22016309,22016486,22017117,22017119,22017120,22017671,22018628,22022614,22023239,22023263,22023724,22023741,22023744,22023748,22024676,22025773,22027683,22027684,22027685,22027686,22027687,22027688,22027689,22027690,22029013,22029496,22030652,22030765,22030786,22030789,22030790,22030791,22030792,22030793,22030794,22030796,22030798,22030799,22030800,22030801,22030803,22030804,22030805,22030806,22030807,22030809,22030811,22030814,22030815,22030820,22030825,22030827,22030828,22030829,22030831,22030833,22030836,22030838,22030839,22030840,22030841,22030842,22030845,22030852,22030853,22030854,22030855,22030856,22030857,22030859,22030860,22030861,22030862,22030868,22030869,22030870,22030871,22030872,22030874,22030876,22030877,22030878,22030882,22030884,22030885,22030886,22030887,22030888,22030890,22030891,22030892,22030893,22030895,22030896,22030897,22030898,22030899,22030903,22030904,22030905,22030906,22030908,22030910,22030911,22030913,22030914,22030915,22030916,22030917,22030920,22030922,22030923,22030925,22030926,22030928,22030929,22030930,22030931,22030932,22030933,22030934,22030935,22030936,22030937,22030938,22030939,22030941,22030942,22030943,22030946,22030947,22030949,22030951,22030957,22030959,22030963,22033574,22033905,22034196,22034960,22037559,22037806,22037896,22037902,22039734,22039870,22043396,22045325,22045333,22045342,22045348,22045365,22045368,22045378,22045401,22046536,22046551,22046904,22047052,22049648,22049657,22049658,22049659,22049684,22051655,22052139,22052140,22055865,22056040,22056044,22056888,22057011,22061985,22062436,22064256,22064518,22065326,22065358,22069087,22069841,22069868,22072168,22072391,22072534,22074069,22074834,22076196,22077154,22077256,22084303,22084811,22085088,22089780,22092390,22092865,22093894,22094301,22094714,22095048,22095083,22095116,22095493,22095572,22095617,22095774,22096125,22096597,22097932,22099228,22099417,22099454,22102304,22103590,22103660,22103680,22108088,22109143,22109144,22109749,22110364,22111296,22111302,22111545,22111831,22111835,22111836,22115662,22117397,22121106,22123184,22124049,22130370,22133357,22134663,22136683,22137721,22138171,22138175,22139007,22139744,22139782,22142920,22143047,22145208,22147013,22147200,22147728,22149733,22149734,22152045,22154200,22154381,22154617,22159670,22161063,22161067,22161069,22161072,22161207,22161209,22161712,22162185,22162366,22162368,22162482,22163388,22163680,22164536,22168019,22168788,22171048,22171854,22171974,22172992,22178879,22185671,22185672,22187488,22188258,22188327,22188403,22188801,22189437,22191959,22193894,22194975,22194976,22194977,22196456,22196830,22197313,22197330,22197998,22198052,22201347,22203349,22203368,22203856,22204301,22205470,22209249,22210823,22210829,22210851,22214247,22215640,22216160,22218003,22218257,22219022,22219300,22220491,22221133,22221488,22221744,22221771,22222510,22227695,22228824,22229037,22234524,22235486,22235715,22235860,22235908,22236158,22236238,22239192,22241176,22242067,22242356,22242821,22242831,22242969,22242987,22243915,22244266,22246538,22246689,22247297,22247298,22247302,22249134,22249658,22249738,22249745,22249802,22250374,22251068,22252123,22253574,22253953,22254256,22256309,22256320,22257108,22257847,22257850,22258205,22258790,22259911,22262410,22262601,22262785,22263565,22263636,22263651,22264765,22265110,22265140,22265309,22268226,22279489,22279905,22280347,22281971,22282677,22284935,22286639,22286918,22288289,22289163,22291487,22293129,22294277,22294367,22294368,22294588,22295508,22295514,22296244,22297483,22297575,22297926,22299154,22301625,22302304,22302413,22303429,22303872,22304346,22304417,22308378,22308869,22309053,22309262,22309786,22310744,22310752,22310927,22311554,22311665,22313553,22315263,22315335,22315402,22315635,22318814,22321206,22324167,22326547,22326582,22326592,22327292,22327727,22327793,22332398,22333374,22335489,22341723,22341808,22342523,22343237,22346553,22346605,22349205,22349746,22350087,22350912,22352601,22355226,22355373,22355415,22355450,22355485,22357380,22357792,22359791,22360805,22360934,22361999,22362002,22362710,22362999,22365504,22366675,22366999,22367361,22367535,22367543,22367564,22367762,22367872,22369799,22373560,22376481,22376560,22376962,22377258,22377265,22377558,22377782,22379162,22379982,22383412,22384380,22387739,22388356,22389215,22389218,22391710,22392445,22393078,22393580,22394071,22397967,22400875,22403003,22404812,22405476,22405487,22406569,22411999,22412013,22414877,22414917,22420564,22422077,22425948,22426812,22427854,22428133,22433810,22434137,22435021,22435333,22435351,22435377,22435383,22436560,22440328,22440669,22441331,22442373,22444925,22445241,22445242,22447572,22448686,22449215,22449916,22449991,22450379,22451013,22451015,22451025,22451030,22451108,22451144,22452743,22455581,22455783,22458052,22459454,22459456,22459622,22460748,22464329,22466113,22467584,22468022,22470170,22470715,22472123,22472166,22472326,22472935,22473288,22473889,22474040,22474288,22476071,22478253,22478254,22478256,22478258,22478259,22478260,22478261,22478263,22478265,22478267,22478268,22478269,22478271,22478272,22478273,22478274,22478275,22478277,22478278,22478279,22478280,22478282,22478283,22478284,22478286,22478289,22478290,22479456,22479729,22481091,22481409,22482522,22483414,22484010,22485845,22486279,22486658,22491080,22491550,22492358,22493037,22493482,22494168,22497789,22502545,22502877,22503002,22503159,22504249,22504778,22505561,22505562,22507349,22508072,22508107,22508124,22508720,22510516,22510601,22511250,22511694,22514321,22515037,22515435,22517445,22519257,22520166,22521352,22521549,22522665,22523345,22524012,22525880,22526217,22526218,22527246,22528408,22529019,22529061,22532164,22533788,22534654,22536553,22536564,22536581,22536614,22537311,22537347,22538832,22542488,22542546,22544150,22544941,22544996,22545765,22545908,22547692,22549843,22550507,22552412,22558095,22558218,22559194,22559388,22559428,22559431,22559624,22559702,22559761,22561219,22564114,22564173,22566404,22566530,22567601,22568294,22569729,22572162,22572415,22572476,22572733,22572747,22573926,22575297,22576209,22576939,22579856,22580801,22581683,22583151,22584427,22584641,22585025,22585060,22587357,22588221,22588223,22588224,22588225,22588227,22588228,22588232,22588233,22588234,22588235,22588236,22588237,22588238,22588239,22588241,22588243,22588244,22588245,22588247,22588248,22588250,22588251,22588252,22588253,22588254,22588255,22588256,22588257,22588258,22588259,22588260,22588261,22588264,22588265,22588266,22588267,22588268,22588269,22588270,22588271,22588272,22588273,22588274,22588275,22588276,22588277,22588279,22588280,22588281,22588282,22588283,22588284,22588285,22588286,22588287,22588288,22588289,22588290,22588291,22588292,22588293,22588294,22588296,22588298,22588299,22588302,22588303,22588304,22588305,22588307,22588309,22588310,22588311,22588312,22588314,22588315,22588316,22588320,22588322,22588332,22588333,22588337,22588340,22588342,22588345,22588348,22588350,22588351,22588358,22588369,22588382,22588388,22588392,22588400,22588402,22588404,22588411,22588421,22588427,22588435,22588440,22588457,22588458,22588459,22588466,22588552,22588596,22588600,22588607,22588617,22588619,22588638,22588642,22588647,22588671,22588697,22588698,22588718,22588721,22588723,22588748,22588756,22588761,22588785,22588879,22588890,22588917,22588948,22588973,22589166,22589247,22589447,22589758,22589766,22589807,22590030,22590032,22590090,22590293,22590429,22590520,22591170,22591214,22591245,22591248,22591262,22591327,22591341,22591375,22591384,22591399,22591426,22591427,22591470,22591487,22591514,22591542,22591590,22591593,22591637,22591640,22591654,22591706,22591723,22591764,22591993,22592080,22592087,22592152,22592208,22592283,22592385,22592401,22592477,22592522,22592527,22592564,22592718,22593181,22593285,22593302,22593303,22593340,22593742,22593818,22593902,22594044,22594124,22594349,22594371,22594564,22594587,22594618,22594803,22594839,22594866,22594945,22594994,22595054,22595085,22595087,22595242,22595290,22595310,22595332,22595422,22595549,22595614,22595691,22595930,22596132,22596227,22596704,22597130,22597203,22598118,22598170,22598803,22600045,22602298,22602608,22602609,22602883,22602898,22603023,22604727,22605545,22605546,22605551,22605552,22605565,22605959,22605977,22606542,22606806,22606861,22607140,22608129,22608876,22609082,22609584,22611756,22611757,22613573,22614081,22614115,22614124,22614330,22614537,22614614,22614646,22614747,22614855,22614930,22615201,22615241,22615494,22615512,22615535,22615706,22615755,22615842,22616076,22616149,22616266,22616302,22616462,22616619,22616784,22616901,22617321,22617362,22617412,22617426,22617544,22617744,22617745,22617794,22617802,22618023,22618034,22618046,22618063,22618118,22618555,22618556,22618557,22618615,22618632,22618685,22619003,22619134,22619193,22619231,22619568,22619619,22619620,22619785,22619897,22619935,22620100,22620101,22620102,22620122,22620242,22620402,22620403,22620488,22620886,22620909,22620920,22620968,22621386,22621503,22621506,22621871,22621872,22621908,22622025,22622043,22622046,22622144,22622175,22622188,22622329,22622372,22622452,22622549,22622550,22622999,22623107,22623138,22623252,22623335,22623341,22623347,22623354,22623704,22623705,22623706,22623724,22623733,22625134,22625167,22625471,22625616,22625872,22625908,22626179,22626180,22626186,22626293,22626568,22627020,22627287,22627311,22627375,22627770,22628031,22630466,22630847,22630862,22631005,22631179,22631472,22631652,22632139,22632211,22632489,22633860,22633967,22634341,22637148,22637859,22637868,22637870,22637894,22638565,22638749,22639457,22640100,22640370,22640509,22641101,22641605,22645228,22646879,22647145,22647292,22647729,22648726,22649108,22649434,22649827,22651687,22653422,22654044,22654047,22654056,22655090,22655592,22655709,22655834,22656054,22656313,22656926,22657391,22658923,22659347,22659363,22660210,22660978,22661142,22661338,22661580,22662240,22662574,22663187,22664463,22665432,22665804,22666111,22666157,22668066,22669466,22670603,22670618,22671644,22672052,22672062,22672833,22673743,22673786,22673963,22674501,22674826,22675700,22675701,22677716,22679421,22679765,22679767,22679789,22679794,22679819,22679821,22679822,22679823,22679826,22679837,22679842,22679976,22679985,22680181,22680182,22681045,22681074,22681099,22681193,22682858,22683381,22684078,22684235,22684762,22685024,22685695,22686427,22686428,22686856,22687036,22687409,22688136,22688137,22688138,22688139,22688140,22688141,22688214,22688238,22688256,22688641,22688890,22692227,22692334,22692698,22693728,22693746,22693771,22693879,22693943,22693996,22694490,22694501,22694600,22694777,22694901,22695364,22695866,22696058,22696203,22696854,22696876,22696953,22697027,22697088,22697184,22697207,22697254,22697403,22697445,22697464,22697511,22699116,22702747,22702750,22702751,22702865,22702989,22703088,22703162,22703611,22704458,22706363,22708728,22709602,22711432,22711799,22713674,22713676,22715726,22715728,22715741,22715745,22716299,22719452,22719612,22719706,22720413,22721393,22722176,22722457,22724875,22724876,22724881,22724943,22725457,22725459,22726363,22726428,22726436,22729097,22731559,22732112,22734772,22734815,22735242,22735380,22735671,22736174,22739624,22739801,22740200,22740253,22740287,22740712,22740853,22744083,22744099,22744358,22745307,22745450,22745562,22746685,22747294,22748161,22748873,22749258,22749259,22749920,22750744,22751012,22752398,22754095,22754106,22754575,22754757,22756775,22760320,22761434,22761681,22762396,22762431,22764855,22764900,22767827,22769227,22772149,22772150,22772496,22773655,22774060,22775760,22777036,22777242,22780092,22780922,22781406,22782418,22783526,22783867,22784744,22786317,22786426,22786641,22786642,22786643,22787609,22789313,22795073,22796455,22796456,22796930,22796993,22798064,22798526,22798537,22798568,22798643,22799791,22800568,22800905,22801097,22801386,22801504,22801896,22801910,22804941,22806140,22806165,22806493,22807567,22808128,22809422,22810485,22812055,22812669,22812955,22813331,22815338,22815774,22815775,22815776,22818394,22818499,22818746,22819870,22822030,22823602,22824460,22825004,22825777,22828460,22828832,22829758,22829806,22831023,22832216,22833012,22833143,22835664,22836009,22836010,22841325,22843550,22844979,22845026,22845253,22846443,22846557,22846796,22846797,22848756,22850791,22851001,22851580,22852723,22853145,22854239,22854275,22854345,22854891,22855175,22855466,22856035,22858248,22858379,22859049,22859386,22859897,22861083,22861166,22862884,22862887,22871734,22875003,22875008,22875469,22876481,22876484,22877341,22877343,22877344,22877345,22877346,22877347,22877348,22877349,22877350,22877351,22877352,22877354,22877355,22877356,22877357,22877359,22877360,22877361,22877362,22877363,22877364,22877365,22877368,22877369,22877370,22877371,22877372,22877373,22877374,22877376,22877377,22877378,22877379,22877380,22877381,22877382,22877383,22877384,22877385,22877386,22877387,22877389,22877391,22877392,22877393,22877394,22877396,22877397,22877398,22877399,22877400,22877401,22877402,22877405,22877406,22877407,22877408,22877409,22877411,22877412,22877413,22877414,22877415,22877416,22877417,22877418,22877419,22877420,22877421,22878290,22878319,22879527,22879533,22879910,22880057,22880332,22880333,22880834,22880835,22880836,22880837,22880839,22880840,22880841,22880842,22880843,22880844,22880845,22880846,22880847,22880848,22880852,22880853,22880854,22880855,22880856,22880857,22880859,22880860,22880861,22880862,22880863,22880864,22880865,22880866,22880867,22880868,22880870,22880871,22880872,22880873,22880874,22880875,22880876,22880877,22880878,22880879,22880880,22880881,22880882,22880883,22880884,22880885,22880886,22880887,22880889,22880891,22880892,22880893,22880894,22880895,22880896,22880897,22880898,22880901,22880903,22880904,22880905,22880906,22880907,22880908,22880909,22880910,22880911,22880912,22880913,22880916,22880917,22880918,22880919,22880920,22880922,22880923,22880924,22880925,22880927,22880928,22880929,22880930,22880931,22880932,22880933,22880934,22880935,22880936,22880937,22880938,22880939,22880940,22880941,22880942,22880943,22880944,22880945,22880946,22880947,22880948,22880949,22880950,22880952,22880953,22880954,22880955,22880956,22880957,22880958,22880959,22880960,22880961,22880962,22880963,22880964,22880965,22880966,22880967,22880968,22880969,22880970,22880971,22880972,22880973,22880975,22880977,22880978,22880979,22880980,22880981,22880982,22880984,22880985,22880986,22880987,22880988,22880989,22880990,22880991,22880992,22880993,22880994,22880995,22880996,22880997,22880998,22880999,22881001,22881761,22881762,22881763,22881764,22881765,22881767,22881768,22881769,22881770,22881771,22881772,22881773,22881774,22881775,22881776,22881777,22881778,22881779,22881781,22881782,22881783,22881784,22881785,22881786,22881787,22881788,22881789,22881790,22881791,22881792,22881793,22881794,22881795,22881796,22881797,22881798,22881799,22881800,22881801,22881803,22881804,22881805,22881807,22881808,22881809,22881810,22881811,22881812,22881813,22881814,22881815,22881816,22881819,22881820,22881821,22881822,22881825,22881826,22881827,22881828,22881830,22881831,22881832,22881833,22881834,22881835,22881837,22883413,22883529,22883530,22883531,22883532,22883533,22883534,22883535,22883537,22883538,22883539,22883540,22883547,22883549,22883551,22883552,22883553,22883554,22883555,22883556,22883607,22883608,22883610,22883611,22883613,22883614,22883615,22883616,22883617,22883618,22883619,22883620,22883622,22883623,22883626,22883627,22883628,22883629,22883630,22883631,22883632,22883634,22883635,22883636,22883637,22883638,22883639,22883640,22883641,22883642,22883643,22883644,22883645,22883646,22883647,22883648,22883649,22883650,22883651,22883653,22883654,22883655,22883656,22883657,22883658,22883659,22883660,22883661,22883662,22883663,22883665,22883666,22883667,22883668,22883669,22883670,22883671,22883672,22883673,22883674,22883675,22883676,22883677,22883678,22883680,22883681,22883682,22883683,22883684,22883685,22883686,22883687,22883688,22883689,22883690,22883691,22883692,22883693,22883694,22883697,22883698,22883699,22883700,22883701,22883702,22883703,22883704,22883705,22883706,22883708,22883711,22883712,22883714,22883715,22883716,22883717,22883719,22883720,22883721,22883724,22883725,22883727,22883728,22883729,22883731,22883733,22883734,22883735,22883736,22883737,22883738,22883739,22883740,22883742,22883743,22883744,22883745,22883746,22883749,22883750,22883751,22883752,22883754,22883755,22883757,22883758,22883759,22883760,22883761,22883762,22883764,22883765,22883766,22883767,22883768,22883769,22883770,22883771,22883773,22883774,22883775,22883776,22883777,22883778,22883779,22883780,22883781,22883782,22883783,22883784,22883785,22883786,22883787,22883788,22883789,22883790,22883791,22883792,22883794,22883797,22883799,22883800,22883801,22883802,22883803,22883804,22883805,22883806,22883807,22883808,22883809,22883810,22883811,22883812,22883813,22883814,22883815,22883816,22883817,22883818,22883819,22883820,22883821,22883822,22883823,22883824,22883825,22883826,22883827,22883828,22883829,22883830,22883831,22883833,22883835,22883837,22883838,22883839,22883840,22883841,22883842,22883843,22883844,22883845,22883846,22883847,22883848,22883849,22883850,22883852,22883853,22883854,22883855,22883857,22883858,22883859,22883860,22883861,22883866,22883870,22883876,22883878,22883883,22883885,22883886,22883888,22883889,22883892,22883895,22883896,22883897,22883898,22883899,22883900,22883901,22883903,22883904,22883905,22883906,22883908,22883909,22883911,22883913,22883914,22883917,22883918,22883919,22883920,22883921,22883923,22883924,22883925,22883927,22883928,22883929,22883930,22883933,22883934,22883935,22883936,22883937,22883938,22883939,22883942,22883946,22884117,22886164,22887186,22887587,22887613,22887878,22887881,22887883,22887884,22887885,22887886,22887888,22887889,22887890,22887891,22887892,22887893,22887894,22887895,22887898,22887899,22887901,22887902,22889000,22889001,22889003,22889004,22889005,22889006,22889007,22889015,22889019,22889020,22889022,22889024,22889029,22889030,22889031,22889034,22889064,22889206,22889491,22889634,22890195,22890196,22890198,22890199,22890200,22890201,22890203,22890206,22890207,22890208,22890209,22890210,22890211,22890214,22890215,22891717,22891813,22891818,22891821,22892270,22892271,22892273,22892274,22892275,22892277,22892278,22892281,22892282,22892283,22892285,22892287,22892288,22892290,22892291,22892292,22892293,22892296,22892297,22892299,22892301,22892302,22892303,22892304,22892305,22892307,22892308,22892309,22892310,22892312,22892314,22892315,22892317,22892318,22892319,22892321,22892322,22892323,22892325,22892326,22892327,22892331,22892334,22892335,22892336,22892337,22892339,22892340,22892341,22892342,22892343,22892344,22892345,22892346,22892347,22892348,22892349,22892350,22892351,22892358,22892359,22892360,22892361,22892363,22892364,22892365,22892366,22892371,22892379,22892384,22892390,22892394,22892735,22893930,22894000,22894082,22895763,22895764,22895832,22895835,22895839,22895847,22895849,22895850,22895852,22895854,22895856,22895863,22896362,22896719,22898288,22898529,22898532,22898533,22898535,22898536,22898537,22898538,22898539,22898540,22898541,22898543,22898544,22899433,22899434,22899435,22899437,22899438,22899603,22900181,22900313,22900316,22900321,22900322,22900324,22900325,22900327,22900331,22900335,22900338,22900339,22900340,22900341,22900346,22900347,22900348,22900349,22900830,22901404,22901416,22901510,22902111,22902356,22903159,22903688,22904356,22904629,22904760,22907638,22907913,22907984,22908290,22908291,22909456,22909860,22911736,22911762,22912152,22912610,22912746,22914286,22914463,22915350,22917536,22918751,22920593,22921172,22922152,22923055,22925331,22929227,22929326,22932365,22933341,22934772,22934822,22936216,22936585,22936970,22936995,22937208,22937698,22937936,22938670,22939000,22939431,22940121,22942023,22942024,22942025,22942030,22942034,22942043,22942515,22944211,22945061,22945077,22945534,22946181,22946742,22947030,22948145,22948375,22948936,22949126,22949612,22949749,22949967,22950024,22950508,22953241,22953643,22953887,22954354,22954516,22954540,22955644,22955679,22955782,22955920,22956259,22958745,22961250,22961363,22961533,22961659,22962023,22962736,22963546,22963997,22963998,22964077,22964129,22964130,22964323,22964545,22964624,22964666,22965513,22965514,22965919,22966101,22966148,22966194,22966195,22966208,22966555,22966609,22966742,22968769,22969372,22969504,22969521,22970094,22970329,22970856,22971378,22971610,22971709,22971711,22971712,22971713,22972984,22973271,22973856,22979078,22979908,22980287,22980923,22981373,22981633,22981635,22982437,22982521,22982755,22982924,22983131,22983235,22983236,22983491,22983527,22983611,22983724,22983817,22984069,22984471,22984667,22984958,22985340,22985945,22986093,22986188,22986351,22986379,22986403,22986430,22986445,22986446,22986496,22986642,22986723,22986724,22986798,22986799,22986800,22986847,22986848,22986905,22987521,22987522,22987618,22988051,22988301,22988366,22988423,22988763,22989386,22989388,22990001,22990490,22990656,22990862,22991406,22991462,22992279,22992879,22993123,22993332,22993424,22993491,22993802,22993944,22993945,22994083,22994100,22994376,22994402,22994465,22994581,22994677,22994691,22994701,22994702,22994703,22994812,22994910,22995023,22995077,22995165,22995218,22995238,22995439,22995460,22996255,22996259,22996364,22996671,22997161,22997207,22997240,22997327,22997578,22997868,22998655,22998707,22998747,22998811,22999316,23000072,23000201,23000258,23000371,23001168,23001196,23001466,23001534,23001790,23001935,23002482,23003100,23003101,23003214,23003215,23003258,23003269,23003301,23003302,23003379,23003398,23003532,23003592,23003630,23003838,23003951,23004011,23004013,23004031,23004073,23004554,23005262,23005263,23005419,23006177,23006223,23006563,23006571,23006573,23006582,23006588,23006613,23006807,23007786,23008028,23008512,23008706,23008961,23009260,23009427,23009461,23009548,23010241,23010242,23010280,23010368,23010703,23011373,23011833,23011894,23011980,23012008,23012109,23012496,23012552,23012555,23012663,23012806,23012807,23012808,23012809,23012810,23012811,23014026,23014358,23014754,23014984,23015713,23016483,23016806,23016841,23017010,23017157,23017163,23017281,23017313,23017314,23017546,23017578,23017961,23018227,23018488,23018589,23018839,23018850,23018903,23019055,23019085,23019086,23019097,23019098,23019334,23019374,23019581,23019734,23019859,23020237,23020319,23020553,23020565,23020570,23020593,23020727,23020767,23021107,23021620,23022672,23022853,23022885,23023152,23023380,23023491,23024263,23024264,23024265,23024281,23024634,23024655,23024766,23025367,23025488,23025489,23025492,23025496,23025752,23025868,23025924,23026388,23026432,23026843,23026844,23027393,23029132,23030023,23030648,23034415,23034687,23034825,23035091,23035273,23036247,23036393,23036563,23036651,23036752,23036987,23037026,23037193,23037194,23037253,23037536,23037537,23037538,23037575,23038159,23038252,23038507,23038638,23038837,23038979,23039063,23039363,23039631,23039813,23039962,23040140,23040357,23040440,23040550,23042142,23042146,23042429,23042664,23042932,23043133,23043457,23043989,23044888,23044959,23045047,23045093,23045094,23045132,23045413,23045454,23046014,23046032,23046035,23046041,23046042,23046199,23046200,23046220,23047088,23047179,23047292,23047293,23047465,23047628,23047812,23047945,23048476,23048607,23049189,23049562,23050054,23050635,23050655,23050805,23050809,23050950,23051892,23053283,23053425,23053427,23053643,23053777,23053818,23054644,23054684,23054724,23055059,23055299,23055300,23055743,23056209,23056268,23056841,23057078,23057194,23057553,23057653,23057713,23058036,23058037,23058776,23059013,23059017,23059139,23059659,23059742,23059764,23059771,23059986,23060414,23060552,23061028,23061658,23062330,23062840,23062875,23062876,23062923,23063906,23063935,23064105,23064252,23064519,23064622,23064624,23064627,23064645,23064676,23064678,23064681,23064695,23064729,23064774,23065044,23065230,23065310,23065717,23065718,23065829,23065900,23066050,23066157,23066250,23066285,23067187,23067372,23067373,23067374,23067375,23067380,23067489,23067759,23067943,23068010,23068638,23068652,23068916,23069941,23070243,23070461,23070564,23070566,23070596,23071416,23071493,23071613,23072068,23072268,23072269,23072327,23072418,23072456,23072553,23072623,23073180,23073248,23073370,23073992,23074580,23074602,23074627,23074733,23075118,23075640,23075795,23075799,23075831,23075835,23075836,23076408,23076981,23077221,23077643,23077685,23077703,23077836,23078238,23078512,23078975,23079227,23079822,23079844,23080635,23081423,23081457,23081489,23081660,23082192,23082466,23085588,23085770,23086950,23086952,23087216,23089119,23089315,23089326,23089342,23089824,23089857,23092005,23092856,23092872,23094664,23094826,23095608,23095647,23095648,23095649,23095651,23095682,23095861,23095864,23096435,23096832,23098139,23099254,23099435,23099865,23099868,23100392,23100401,23100826,23101317,23102551,23103200,23104477,23104901,23104911,23106801,23106917,23108154,23108492,23108909,23109460,23109729,23109856,23109950,23109964,23110169,23110440,23110628,23110633,23110635,23111098,23111119,23114052,23114226,23115167,23115786,23115884,23115948,23115995,23116294,23116377,23117674,23118650,23118704,23120866,23122396,23124077,23124253,23124605,23125188,23125778,23125779,23125780,23126498,23126507,23126889,23126912,23127073,23127491,23128122,23128715,23129919,23129920,23129943,23130012,23130032,23130520,23130692,23130710,23130769,23130772,23131125,23131174,23131294,23131314,23131532,23131852,23132062,23132321,23132329,23132337,23132338,23132355,23132381,23132659,23133766,23134745,23134757,23134778,23136180,23137345,23138272,23140179,23140774,23140914,23141932,23142801,23143920,23143927,23144067,23144251,23144616,23144630,23144750,23144965,23145146,23145234,23146010,23146050,23146139,23146276,23146934,23147182,23147449,23147483,23147800,23147849,23148103,23148479,23148873,23149551,23149700,23150253,23150884,23151070,23151286,23152466,23152490,23152608,23153935,23155156,23155165,23155247,23155622,23156076,23156312,23156369,23156705,23156768,23156866,23157044,23157130,23157138,23157172,23157332,23157353,23157507,23157667,23157869,23158365,23159740,23160549,23161154,23161623,23161896,23161929,23162346,23163162,23163452,23163462,23163704,23163853,23164350,23164394,23164878,23164884,23165055,23165286,23165336,23165371,23165610,23165821,23166079,23166092,23166302,23166304,23166306,23166437,23166714,23169154,23169630,23170145,23170680,23170718,23171722,23172158,23172908,23173356,23173379,23173456,23173602,23173631,23173633,23174639,23174712,23174716,23174871,23175044,23175201,23175446,23175450,23175512,23175698,23175769,23175997,23176807,23176985,23177541,23177698,23177725,23177862,23178530,23178536,23179338,23179481,23179565,23179566,23180779,23181082,23181198,23181311,23181715,23182094,23182273,23182383,23182506,23182515,23182623,23182722,23182779,23182831,23182894,23182930,23183010,23183013,23183019,23183103,23183120,23183189,23183339,23183428,23183639,23183646,23183656,23183689,23183712,23183726,23183790,23183801,23183821,23183976,23184053,23184087,23184181,23184264,23184499,23184602,23184756,23184764,23185086,23185230,23185259,23185287,23185429,23185485,23185539,23185871,23186074,23186276,23186466,23186720,23186994,23187104,23187143,23187268,23187397,23187413,23187628,23187635,23187712,23187763,23188263,23188272,23188540,23188642,23188808,23188852,23189803,23190480,23190520,23190636,23191426,23191435,23192125,23193927,23193934,23193987,23197517,23197838,23197989,23198055,23198894,23199251,23199260,23199315,23199434,23199442,23199607,23199611,23200500,23200612,23200618,23201321,23201800,23202105,23202852,23202862,23203103,23203395,23203611,23203667,23203898,23204002,23204222,23204223,23204224,23204225,23204381,23205235,23205415,23205687,23205919,23206013,23206311,23206322,23206595,23206600,23206678,23207236,23208083,23208096,23208099,23209116,23209605,23210045,23210177,23210968,23211294,23211670,23212096,23212317,23212352,23212457,23212918,23213194,23213226,23213851,23213873,23213891,23213916,23214018,23214068,23214292,23214327,23214460,23214461,23214463,23214468,23214469,23214470,23214471,23214472,23214473,23214474,23214475,23214483,23214484,23214485,23214486,23214489,23214494,23214502,23214504,23214514,23214515,23214517,23214519,23214526,23214527,23214528,23214533,23214534,23214591,23214656,23214672,23214681,23214740,23214815,23215081,23215208,23215247,23215248,23215374,23215483,23215603,23217492,23217738,23217744,23217783,23217886,23217895,23218444,23218583,23218708,23218944,23218945,23218953,23220253,23221142,23221173,23221434,23221639,23221905,23221922,23222308,23222356,23222491,23222493,23223007,23223044,23223063,23223533,23223557,23223641,23223908,23224448,23224472,23224477,23226653,23227574,23228163,23228349,23228428,23229532,23229633,23229645,23229951,23229996,23229997,23230037,23230334,23230354,23230815,23231245,23231670,23231730,23231739,23232880,23233165,23233183,23233323,23233441,23233443,23233474,23233476,23233511,23233601,23233736,23233803,23233869,23233879,23233884,23234124,23234331,23234353,23234864,23235834,23235876,23237160,23237503,23237823,23238035,23238127,23238500,23238715,23238916,23239111,23239485,23239586,23240422,23240429,23240446,23240458,23240796,23240884,23240911,23240961,23241143,23241179,23241413,23241844,23241850,23241858,23241860,23241862,23241863,23241871,23241887,23241891,23242058,23242627,23242752,23242754,23242910,23242992,23244042,23244144,23244380,23244419,23244489,23244568,23244744,23244745,23244883,23244924,23245294,23245386,23245464,23245616,23245744,23245949,23245959,23245961,23245994,23246002,23246003,23246004,23246005,23246007,23246008,23246010,23246055,23246060,23246061,23246062,23246064,23246065,23246070,23246072,23246082,23246086,23246087,23246088,23246089,23246129,23246132,23246143,23246190,23246191,23246192,23246195,23246230,23246290,23246328,23246420,23248155,23249218,23249219,23249220,23249230,23249659,23250191,23250464,23250494,23250730,23252298,23252540,23252631,23254000,23255059,23255748,23255887,23256379,23256624,23256703,23256929,23257333,23257543,23257832,23258123,23258124,23258298,23259005,23259198,23259211,23259368,23260309,23261812,23261817,23261847,23262090,23262266,23262277,23262341,23263482,23264599,23264992,23265012,23265284,23265318,23265803,23266870,23267370,23267491,23267713,23267850,23268407,23269029,23269822,23270057,23270157,23270162,23270176,23270202,23270205,23270206,23270208,23270215,23270218,23271097,23271321,23271461,23271527,23272388,23273005,23273006,23273020,23273022,23273434,23273574,23273671,23273673,23274233,23274370,23274520,23274838,23275447,23275804,23276549,23276679,23277455,23277646,23278439,23278454,23278468,23278837,23278988,23279423,23279464,23279857,23279970,23279971,23279976,23279988,23280008,23280009,23280010,23280571,23280735,23280736,23280737,23281004,23281152,23281305,23281923,23282653,23283234,23283324,23283356,23283464,23283739,23284319,23284453,23284995,23285273,23285276,23285288,23285361,23286069,23286107,23286248,23286582,23286608,23286610,23287205,23287443,23287446,23287549,23287573,23287711,23288316,23288617,23288618,23288708,23288781,23288838,23288854,23288855,23288863,23288864,23289143,23289153,23289625,23289633,23289673,23289681,23289684,23289704,23289705,23290117,23290865,23292294,23293002,23293117,23293531,23293981,23294207,23294849,23294883,23295044,23295204,23295371,23295743,23296139,23296143,23296205,23296546,23296583,23297011,23297095,23297139,23297318,23297547,23297553,23297554,23297556,23297567,23297575,23297587,23297588,23297605,23297606,23297608,23297609,23297615,23297616,23297620,23297816,23297954,23297955,23297987,23297990,23298067,23298237,23298604,23298998,23299407,23299479,23299484,23299681,23299898,23300048,23300277,23301124,23301125,23301126,23301326,23301403,23301419,23301485,23301593,23302140,23302149,23302171,23302176,23302179,23302185,23302186,23302200,23302214,23302216,23302217,23302218,23302223,23302225,23302226,23302228,23302232,23302237,23302239,23302241,23302248,23302252,23302262,23302264,23302308,23302310,23302312,23302319,23302320,23302338,23302371,23302372,23302379,23302383,23302387,23302388,23302391,23302626,23302689,23302854,23304194,23304268,23304520,23305139,23305652,23306807,23307187,23307346,23307355,23307615,23307635,23307762,23308325,23308729,23308733,23308746,23309297,23309755,23311108,23312425,23312594,23313047,23313048,23313050,23313051,23313052,23313053,23313054,23313862,23313939,23314062,23314206,23314309,23314314,23314639,23314935,23316488,23316826,23317453,23317715,23317717,23317882,23317907,23318332,23318578,23318679,23318952,23318984,23319005,23319689,23319900,20868383,20880210,20890408,20928965,20963825,21008291,21032276,21032298,21037429,21046164,21051081,21051135,21060606,21079855,21080369,21108507,21114270,21126356,21171382,21198966,21199017,21199024,21199028,21199098,21199099,21199100,21199102,21199125,21199138,21199188,21199189,21199198,21199200,21199202,21199203,21199242,21217979,21225224,21252735,21252829,21254278,21254538,21260143,21262099,21324385,21403795,21403899,21434779,21449672,21457084,21461074,21461085,21465310,21483664,21490587,21506099,21529192,21538539,21539962,21546010,21551451,21553913,21576017,21598033,21613334,21620787,21621499,21631252,21634631,21637362,21641781,21642586,21647423,21651942,21654391,21670888,21690114,21698506,21701687,21719235,21748980,21749484,21757079,21757978,21758132,21758811,21759948,21764201,21766486,21768737,21845576,21862562,21868742,21870560,21877430,21882309,21912029,21916585,21926654,21928241,21931641,21950038,21950143,21963845,21963954,21970667,21977211,21977641,21989747,21989783,22001971,22005883,22025002,22028364,22028897,22034938,22050230,22053502,22056616,22060217,22061590,22063016,22065039,22073363,22083245,22085083,22085301,22096747,22109602,22119199,22125427,22142434,22151192,22153513,22156812,22163347,22164771,22168223,22177299,22177497,22180643,22187767,22192124,22200094,22217489,22217490,22219613,22255624,22255941,22265908,22267349,22268543,22283669,22284332,22284607,22295231,22306305,22306334,22310893,22312569,22315260,22318515,22318625,22330287,22331036,22337529,22344403,22353180,22354691,22357784,22357861,22358303,22360316,22363245,22365613,22368897,22369091,22378383,22387694,22394433,22397935,22400034,22423765,22430078,22435489,22436887,22445082,22465900,22475195,22486080,22486720,22493760,22503735,22505868,22511853,22519730,22522319,22527193,22529541,22546000,22547105,22550413,22554227,22554492,22566558,22583326,22588639,22600960,22617469,22623348,22642156,22648377,22655332,22661696,22667102,22669390,22669624,22670745,22674940,22687813,22696649,22697533,22704642,22705839,22714414,22727304,22739176,22744916,22764548,22783758,22787562,22793681,22805669,22809987,22812864,22821158,22821162,22831642,22834903,22839740,22845033,22849580,22861071,22861817,22863739,22865986,22890953,22917472,22917833,22918537,22941041,22956976,22957602,23004847,23005030,23005050,23007405,23012911,23012973,23020141,23023317,23029429,23046410,23048841,23050066,23050418,23057760,23057808,23067123,23094269,23095281,23112403,23115533,23118885,23125651,23127567,23132311,23141876,23148397,23156788,23166047,23172933,23183128,23189515,23191502,23198738,23204164,23205744,23206203,23215255,23241650,23244275,23246270,23249861,23251351,23257340,23275448,23294325,23295759,23296726,23297261,23297430,23297778,23300819,23301519,23302155,23305264,23306246,23307453,23319761,22640077,22710374,22964764,23002040,23056283,23107758,23202749
)


EOQ;
        $ri = $this->dbAdapter->query($sql)->execute (null);
        $orders = ResultInterfaceToArray($ri);

        $this->connector = new LogicCreditJudgeConnectorIlu($this->configs['cj_api']);

        // ILUシステムへ注文を登録
        foreach ($orders as $order) {
            $retry = 0;
            $retry_max = 2;
            while(++$retry <= $retry_max) {
                try {
                    // ILUシステム連携
                    $this->sendTo($order['OrderSeq']);
                    break;  // エラーなしなら処理終了
                } catch(LogicCreditJudgeSystemConnectException $connError) {
                    // 接続絡みの例外時は既定回数リトライ
                    $this->logger->debug((sprintf('[%s] SystemConnect::sentTo exception(%s times). -> %s', $order['OrderSeq'], $retry, $connError->getMessage())));
                    if($retry < $retry_max) {
                        // 既定回数未満の場合は1秒WAITを入れる
                        usleep(1 * 1000000);
                    } else {
                        // 既定回数に達したらエラー
                        throw $connError;
                    }
                } catch(\Exception $err) {
                    // その他の例外は上位へスロー
                    throw $err;
                }
            }
        }

$this->logger->info('CreditInspection end');
$this->logger->info(sprintf('CreditInspection elapsed time = %s', (microtime(true) - $start)));
    }


    /**
     * 審査システムへ注文情報を送信し、結果を永続化する
     *
     * @param $oseq 注文SEQ
     */
    private function sendTo($oseq){

        // 送信処理実行
        $this->sendToIlu($oseq);

        // 受信結果を保存
        $this->saveResult($oseq);

        // 送受信データをログとして永続化
        $this->saveLog($oseq);
    }

    /**
     * 指定注文の情報をILU審査システムへ送信する
     *
     * @access private
     * @param $oseq 注文SEQ
     */
    private function sendToIlu($oseq) {

        $connector = $this->connector;

        // 送信データ生成
        $params = $this->buildRequestParams($oseq);
        // 送信実行
        $result = $connector->connect($params);

        // 結果を退避(解析済みデータ)
        // ※：XML形式のデータは送受信ともILUコネクタにキャッシュされているので
        //    必要な場合はそこから取得する
        $this->setReceivedData($result);
    }

    /**
     * 審査システム送信向けのデータをDBから取得する
     *
     * @access private
     * @param int $oseq 注文SEQ
     * @return array 連携送信に必要な注文関連データ一式を格納した連想配列
     */
    private function buildRequestParams($oseq) {

        //----- system_id用データ取得
        $system_id = array('system_id' => $this->configs['cj_api'][LogicCreditJudgeOptions::ILU_ID]);

        //----- order_info用データ取得 --------

        // 注文情報取得
        $order_data = $this->getOrder($oseq);

        // 送料・手数料情報取得
        $order_items = $this->getFees($oseq);

        //----- customer_info用データ取得 --------

        //顧客情報取得
        $customer_data = $this->getCustomer($oseq);

        //取得した郵便番号は-を取り除く
        $customer_data['PostalCode'] = str_replace("-", "", $customer_data['PostalCode']);

        //----- destination_info用データ取得 --------

        //データ取得前に初期化
        $destination_data = array();

        //別配送先フラグが立っていれば届先情報取得
        if(intval($order_data['AnotherDeliFlg'])){
            $destination_data = $this->getDestination($oseq);

            //-をに変換
            $destination_data['PostalCode'] = str_replace("-", "", $destination_data['PostalCode']);
        }

        //----- order_detail用データ取得 --------

        //明細情報取得
        $order_detail_data = $this->getOrderDetail($oseq);

        // すべてのデータをキーに関連付けて返す
        return array(
                'system_id' => $system_id,
                'order_data' => $order_data,
                'order_items' => $order_items,
                'customer_data' => $customer_data,
                'destination_data' => $destination_data,
                'order_detail_data' => $order_detail_data
        );
    }

    /**
     * 注文情報取得
     * @access private
     * @param $oseq 注文Seq
     * @return array　注文情報
     */
    private function getOrder($oseq) {

        //注文情報を取得するSQL作成
        $q = <<<EOQ
SELECT EnterpriseId,OrderId,ReceiptOrderDate,
SiteId,Ent_OrderId,UseAmount,AnotherDeliFlg,Ent_Note
FROM T_Order
WHERE %s
EOQ;
        $query = sprintf($q, " OrderSeq = :OrderSeq ");

        //注文情報取得
        $ri = $this->dbAdapter->query($query)->execute(array(':OrderSeq' => $oseq));

        //取得できなかった場合例外
        if (!($ri->count() > 0)) {
            throw new \Exception(sprintf('order data not found, seq = %s', $oseq));
        }

        $rs = new ResultSet();
        $rs->initialize($ri);
        return $rs->toArray()[0];
    }

    /**
     * 送料・手数料取得
     * @access private
     * @param $oseq 注文Seq
     * @return array　注文情報
     */
    private function getFees($oseq) {

        //送料取得SQL作成
        $q = <<<EOQ
SELECT SumMoney FROM T_OrderItems
WHERE %s
EOQ;
        $query = sprintf($q, " DataClass = 2 AND OrderSeq = :OrderSeq ");

        //送料取得
        $ri = $this->dbAdapter->query($query)->execute(array(':OrderSeq' => $oseq));

        //取得できなかった場合例外
        if (!($ri->count() > 0)) {
            throw new \Exception(sprintf('carriage fee not found, seq = %s', $oseq));
        }
        $postage_data = $ri->current();

        //手数料SQL作成
        $query = sprintf($q, " DataClass = 3 AND OrderSeq = :OrderSeq ");

        //注文情報取得
        $ri = $this->dbAdapter->query($query)->execute(array(':OrderSeq' => $oseq));

        //取得できなかった場合例外
        if (!($ri->count() > 0)) {
            throw new \Exception(sprintf('charge fee not found, seq = %s', $oseq));
        }
        $commission_data = $ri->current();

        return array(
                "postage" => $postage_data['SumMoney'],
                "commission" => $commission_data['SumMoney'] );
    }

    /**
     * 顧客情報取得
     * @access private
     * @param $oseq 注文Seq
     * @return array　顧客情報
     */
    private function getCustomer($oseq) {

        //顧客情報取得
        $mdlmc = new TableManagementCustomer($this->dbAdapter);
        $ri = $mdlmc->findByOrderSeq($oseq);

        //取得できなかった場合例外
        if (!($ri->count() > 0)) {
            throw new \Exception(sprintf('customer data not found, seq = %s', $oseq));
        }

        $rs = new ResultSet();
        $rs->initialize($ri);
        return $rs->toArray()[0];
    }

    /**
     * 別配送先取得
     * @access private
     * @param $oseq 注文Seq
     * @return array　別配送先取得
     */
    private function getDestination($oseq) {

        //別配送先SQL作成
        $q = <<<EOQ
SELECT PostalCode,UnitingAddress,DestNameKj,DestNameKn,Phone
FROM V_Delivery
WHERE %s
EOQ;
        $query = sprintf($q, " DataClass = 1 AND OrderSeq = :OrderSeq ");

        //別配送先取得
        $ri = $this->dbAdapter->query($query)->execute(array(':OrderSeq' => $oseq));

        //取得できなかった場合例外
        if (!($ri->count() > 0)) {
            throw new \Exception(sprintf('destination data not found, seq = %s', $oseq));
        }

        $rs = new ResultSet();
        $rs->initialize($ri);
        return $rs->toArray()[0];
    }

    /**
     * 注文詳細(送料・手数料は含まない)
     * @access private
     * @param $oseq 注文Seq
     * @return array　注文詳細取得
     */
    private function getOrderDetail($oseq) {

        //注文詳細SQL作成
        $q = <<<EOQ
SELECT ItemNameKj,UnitPrice,ItemNum
FROM T_OrderItems
WHERE %s
EOQ;
        $query = sprintf($q, " DataClass = 1 AND ValidFlg = 1 AND OrderSeq = :OrderSeq ");

        //注文詳細取得
        $ri = $this->dbAdapter->query($query)->execute(array(':OrderSeq' => $oseq));

        //取得できなかった場合例外
        if (!($ri->count() > 0)) {
            throw new \Exception(sprintf('orderitems data not found, seq = %s', $oseq));
        }

        $rs = new ResultSet();
        $rs->initialize($ri);
        return $rs->toArray();
    }

    /**
     * 受信結果をDBに保存
     *
     * @access private
     * @param $oseq 注文SEQ
     */
    private function saveResult($oseq) {

        // 受信データ取得
        $rcv_data = $this->getReceivedData();

        try{
            // XML受信結果がOKだったら
            if($rcv_data['result'] == "OK"){
                // 管理顧客に審査システム顧客IDを保存
                $this->saveIluCustomerId($rcv_data);

                // 取得した内容を与信注文ID管理に格納
                $this->saveCjOrderIdControl($oseq, $rcv_data);
            }else{
                //OK以外は処理なし
                $this->logger->debug('ILU Connect Result NG.');
            }
        }catch(\Exception $err){
            //エラーメッセージ取得
            $error_msg = $err->getMessage();
            throw new \Exception("Error saveResult : " . $error_msg);
        }
    }

    /**
     * 審査システム顧客ID保存
     *
     * @access protected
     * @param $resp_data 受信データ
     */
    protected function saveIluCustomerId($resp_data) {

        //モデル
        $mngCust = new TableManagementCustomer($this->dbAdapter);

        //名寄せ情報がある場合のみ
        if (!is_null($resp_data['aggregation_list'])) {
            //与信審査した注文の顧客ID
            $orderManCustId = $resp_data['aggregation_list']->customer_info->system_customer_id;
            $orderIluCustomerId = $resp_data['aggregation_list']->customer_info->customer_id;

            if (!empty($orderManCustId)) {
                // 統合先の管理顧客
                $mc = $mngCust->find($orderManCustId)->current();
                if ($mc === false) {
                    // 統合先の管理顧客が存在しない場合、更新しない
                    return;
                }

                if ($mc != false && empty($mc['IluCustomerId']) && !empty($orderIluCustomerId)) {
                    // 管理顧客の審査システム－顧客ＩＤが未設定の場合、設定
                    $mngCust->saveUpdate(array(
                            'IluCustomerId' => $orderIluCustomerId,
                            'UpdateId' => $this->userId,
                    )
                    , $orderManCustId
                    );
                }
            }
        }
    }

    /**
     * 与信注文ID管理書き込み
     *
     * @access private
     * @param $order_seq 注文SEQ
     * @param $rcv_data 受信データ
     * @return int 結果値
     */
    private function saveCjOrderIdControl($order_seq, $rcv_data) {

        //与信注文ID管理
        $cjoc = new TableCjOrderIdControl($this->dbAdapter);

        // 注文Seqで該当するデータ取得
        $cjocData = $cjoc->find($order_seq);

        // データが存在しない場合、登録する
        if ($cjocData->count() == 0) {
            //注文ID
            $iluOrderId = $rcv_data['inspect_result']->order_info->order_id;

            //登録
            $data = array(
                    'OrderSeq' => $order_seq,
                    'IluOrderId' => $iluOrderId,
                    'RegistId' => $this->userId,
            );
            $cjoc->saveNew($data);
        }
    }

    /**
     * XML送信データ・受信データをログファイルとして保存する
     *
     * @access private
     * @param int $oseq 注文番号
     */
    private function saveLog($oseq) {

        //保存先取得
        $save_dir = $this->configs['cj_api'][LogicCreditJudgeOptions::SAVE_DIR];

        //送信データ保存
        $sent_data = $this->getSentXml();
        $sent_path = f_path($save_dir, 'iko_creditinspection_' . $oseq . '.xml', DIRECTORY_SEPARATOR);
        $sent_data_saved = @file_put_contents($sent_path, $sent_data);

        //受信データ保存
        $received_data = $this->getReceivedXml();
        $received_path =
        f_path($save_dir, sprintf('iko_creditinspection_%s_%s.xml', $oseq, date('YmdHis')), DIRECTORY_SEPARATOR);
        $received_data_saved = @file_put_contents($received_path, $received_data);

        // どちらかの保存に失敗した場合は例外
        if(!$sent_data_saved || !$received_data_saved) {
            $files = array();
            if(!$sent_data_saved) $files[] = $sent_path;
            if(!$received_data_saved) $files[] = $received_path;
            $msg = sprintf('cannot save log file: %s', join(' and ', $files));
            throw new \Exception($msg);
        }
    }

    /**
     * 支払情報連携
     */

    // 20160208-sode 変更 T_CjOrderIdControlの結合を[外部結合]⇒[内部結合]化
    /* 20160213-sode 変更　	支払額0で審査システムにデータを渡すと、審査システムでは入金日で日付で請求期限日が更新されてしまう
     支払額0の場合は入金日ではなく、請求期限日をdate句にセットする
    　　１－１）入金された注文（一部入金含む）通常の注文
    変更前：MAX(p.ReceiptDate)           AS ReceiptDate
    変更後： (CASE WHEN MAX(c.ReceiptAmountTotal) > 0 THEN MAX(p.ReceiptDate) ELSE c.F_LimitDate END)   AS ReceiptDate
    */


    private function SetPaymentData() {

        $start = microtime(true);
$this->logger->info('SetPaymentData start');

        // 支払い情報編集URL
        $setPaymentDataUrl = $this->configs['cj_api']['SetPaymentData'];

        $sql = <<<EOQ
/* １－１）入金された注文（一部入金含む）通常の注文 */
SELECT MAX(o.OrderId)               AS OrderId
     , MAX(o.DataStatus)            AS DataStatus
     , MAX(c.ReceiptAmountTotal)    AS ReceiptAmountTotal
     , MAX(o.UseAmount)             AS UseAmount
     , (CASE WHEN MAX(c.ReceiptAmountTotal) > 0 THEN MAX(p.ReceiptDate) ELSE c.F_LimitDate END)   AS ReceiptDate
     , NULL                         AS P_OrderSeq
     , MAX(co.IluOrderId)           AS IluOrderId
     , 5                            AS type
  FROM T_ReceiptControl p
       INNER JOIN T_Order o ON o.P_OrderSeq = p.OrderSeq
       INNER JOIN T_ClaimControl c ON o.P_OrderSeq = c.OrderSeq
       INNER JOIN T_CjOrderIdControl co ON co.OrderSeq = o.OrderSeq
 WHERE 1 = 1
   AND o.DataStatus = 61
   AND IFNULL(o.CloseReason, 0) <> 2
   AND IFNULL(o.CombinedClaimTargetStatus, 0) = 0
   AND IFNULL(o.OutOfAmends, 0) <> 1
   AND o.T_OrderClass = 0
 GROUP BY o.OrderSeq

/* １－２）入金された注文（一部入金含む）請求取りまとめ対象の注文 */
UNION ALL
SELECT MAX(o.OrderId)               AS OrderId
     , MAX(o.DataStatus)            AS DataStatus
     , MAX(c.ReceiptAmountTotal)    AS ReceiptAmountTotal
     , MAX(o.UseAmount)             AS UseAmount
     , MAX(p.ReceiptDate)           AS ReceiptDate
     , MAX(o.P_OrderSeq)            AS P_OrderSeq
     , MAX(co.IluOrderId)           AS IluOrderId
     , 6                            AS type
  FROM T_ReceiptControl p
       INNER JOIN T_Order o ON o.P_OrderSeq = p.OrderSeq
       INNER JOIN T_ClaimControl c ON o.P_OrderSeq = c.OrderSeq
       INNER JOIN T_CjOrderIdControl co ON co.OrderSeq = o.OrderSeq
 WHERE 1 = 1
   AND o.DataStatus = 61
   AND IFNULL(o.CloseReason, 0) <> 2
   AND IFNULL(o.CombinedClaimTargetStatus, 0) IN (91,92)
   AND IFNULL(o.OutOfAmends, 0) <> 1
   AND o.T_OrderClass = 0
 GROUP BY o.OrderSeq

/* ２）初回請求書（初回請求書再発行含む）が発行された注文 */
/* 20160207-sode 変更 cc.F_ClaimDate →cc.F_LimitDate */
UNION ALL
SELECT MAX(o.OrderId)               AS OrderId
     , MAX(o.DataStatus)            AS DataStatus
     , MAX(cc.ReceiptAmountTotal)   AS ReceiptAmountTotal
     , NULL                         AS UseAmount
     , MAX(cc.F_LimitDate)          AS ReceiptDate
     , NULL                         AS P_OrderSeq
     , MAX(co.IluOrderId)           AS IluOrderId
     , 4                            AS type
  FROM T_Order o
       INNER JOIN T_ClaimControl cc ON cc.OrderSeq = o.P_OrderSeq
       INNER JOIN T_ClaimHistory ch ON ch.OrderSeq = o.P_OrderSeq
       INNER JOIN T_CjOrderIdControl co ON co.OrderSeq = o.OrderSeq
 WHERE 1 = 1
   AND o.DataStatus = 51
   AND ch.ClaimPattern = 1
   AND ch.PrintedFlg = 1
   AND ch.ValidFlg = 1
   AND IFNULL(o.CloseReason, 0) <> 2
   AND IFNULL(o.OutOfAmends, 0) <> 1
   AND o.T_OrderClass = 0
 GROUP BY o.OrderSeq

ORDER BY type
       , OrderId
EOQ;
        $ri = $this->dbAdapter->query($sql)->execute ($prm);
        $orders = ResultInterfaceToArray($ri);

        if (count($orders) > 0) {
            // 対象がある場合のみ処理を実行

            // リクエストパラメータ用にデータ整形
            $paramDatas = array();
            $oldPOrderSeq = 0;
            $paymentBalance = 0;
            foreach ($orders as $order) {
                $paramData = array();

                if ($order['type'] == 4) {
                    // ２）初回請求書（初回請求書再発行含む）が発行された注文

                    // 注文ID
                    $paramData['order_id'] = $order['IluOrderId'];

                    // システム注文ID
                    $paramData['system_order_id'] = $order['OrderId'];

                    // 注文ステータス
                    // 未払い
                    $status = 10;
                    $paramData['status'] = $status;

                    // 連番
                    $paramData['sequence'] = 1;

                    // 支払額
                    $paramData['paid_amount'] = 0;

                    // 支払い期日 or 最終入金日
                    $paramData['date'] = $order['ReceiptDate'];
                }
                elseif ($order['type'] == 5) {
                    // １－１）入金された注文（一部入金含む）通常の注文

                    // 注文ID
                    $paramData['order_id'] = $order['IluOrderId'];

                    // システム注文ID
                    $paramData['system_order_id'] = $order['OrderId'];

                    // 注文ステータス
                    // 一部支払い
                    $status = 20;
                    $paramData['status'] = $status;

                    // 連番
                    $paramData['sequence'] = 1;

                    // 支払額
                   // $paramData['paid_amount'] = $order['ReceiptAmountTotal'];
                    // 支払額
                    // 20160208-sode 変更 過剰の場合はUseAmountとする
                    $paramData['paid_amount'] = ($order['ReceiptAmountTotal'] > $order['UseAmount']) ? $order['UseAmount'] : $order['ReceiptAmountTotal'];

                    // 支払い期日 or 最終入金日
                    $paramData['date'] = $order['ReceiptDate'];
                }
                elseif ($order['type'] == 6) {
                    // １－２）入金された注文（一部入金含む）請求取りまとめ対象の注文

                    // 請求取りまとめの親番号が変わった場合
                    if ($oldPOrderSeq != $order['P_OrderSeq']) {
                        // 入金残設定
                        $paymentBalance = $order['ReceiptAmountTotal'];

                        // 請求取りまとめ親番号設定
                        $oldPOrderSeq = $order['P_OrderSeq'];
                    }

                    // 支払額計算
                    $paid_amount = 0;
                    if ($paymentBalance >= $order['UseAmount']) {
                        // 利用額以上の入金がある場合、満額支払い
                        $paid_amount = $order['UseAmount'];

                        // 入金残から利用額を減らす
                        $paymentBalance -= $order['UseAmount'];
                    }
                    else {
                        // 利用額未満の場合、入金残が支払額
                        $paid_amount = $paymentBalance;

                        // 入金残は0
                        // TODO 20160213-sode 支払額($paid_amount)0となるときは、date句に請求期限をセットする
                        // （T.ClaimControl.F_LimitDateを取得し、$order['ReceiptDate']にセットする
                        if ( $paid_amount <= 0 ) {
                        	$ri = $mdlcc->findClaim(array('OrderSeq' => $order['P_OrderSeq']));
                        	$prmDate = $ri->current()['F_LimitDate'];
                        }

                        // 入金残は0
                        $paymentBalance = 0;
                    }

                    // 注文ID
                    $paramData['order_id'] = $order['IluOrderId'];

                    // システム注文ID
                    $paramData['system_order_id'] = $order['OrderId'];

                    // 注文ステータス
                    $status = '';
                    if ($paid_amount == $order['UseAmount']) {
                        // 支払済
                        $status = 30;
                    }
                    elseif ($paid_amount > 0) {
                        // 一部支払い
                        $status = 20;
                    }
                    else {
                        // 未払い
                        $status = 10;
                    }
                    $paramData['status'] = $status;

                    // 連番
                    $paramData['sequence'] = 1;

                    // 支払額
                    $paramData['paid_amount'] = $paid_amount;

                    // 支払い期日 or 最終入金日
                    $paramData['date'] = $order['ReceiptDate'];
                }

                if (count($paramData) > 0) {
                    if (strlen($paramData['date']) > 0) {
                        // 日付の形式変換
                        $paramData['date'] = date('Y/m/d', strtotime($paramData['date']));
                    }
                    $paramDatas[] = $paramData;
                }
            }

            // 支払い情報編集API連携

            // リクエストパラメータ作成
            $reqParams = $this->createRequestParamsPayment($paramDatas);

            // WebAPI連携実行
            $response = $this->apiConnect($setPaymentDataUrl, $reqParams);

//            // レスポンス解析
//            $resData = $this->getResponseInfoPayment($response);

            //保存先取得
            $save_dir = $this->configs['cj_api'][LogicCreditJudgeOptions::SAVE_DIR];

            //送信データ保存
            $sent_data = $reqParams;
            $sent_path = f_path($save_dir, 'iko_setpaymentdata.xml', DIRECTORY_SEPARATOR);
            $sent_data_saved = @file_put_contents($sent_path, $sent_data);

            //受信データ保存
            $received_data = $response;
            $received_path = f_path($save_dir, sprintf('iko_setpaymentdata_%s.xml', date('YmdHis')), DIRECTORY_SEPARATOR);
            $received_data_saved = @file_put_contents($received_path, $received_data);

            // どちらかの保存に失敗した場合は例外
            if(!$sent_data_saved || !$received_data_saved) {
                $files = array();
                if(!$sent_data_saved) $files[] = $sent_path;
                if(!$received_data_saved) $files[] = $received_path;
                $msg = sprintf('cannot save log file: %s', join(' and ', $files));
                throw new \Exception($msg);
            }
        }

$this->logger->info('SetPaymentData end');
$this->logger->info(sprintf('SetPaymentData elapsed time = %s', (microtime(true) - $start)));
    }

    /**
     * 支払い情報編集APIリクエストパラメータ作成
     *
     * @param array $data
     * @return string リクエストパラメータ（XML文字列）
     */
    private function createRequestParamsPayment($data) {

        // システムID
        $system_id = $this->configs['cj_api'][LogicCreditJudgeOptions::ILU_ID];

        // XMLデータ作成
        $doc = new \DOMDocument("1.0", "utf-8");

        // 支払い情報編集
        $rootElement = $doc->appendChild($doc->createElement("payment_list"));

        foreach ($data as $order) {
            // 支払い情報
            $paymentinfoElement = $doc->createElement("payment_info");

            // 注文IDがある場合、注文IDのみ指定
            if (!empty($order['order_id'])) {
                // 注文ID
                $orderidElement = $paymentinfoElement->appendChild($doc->createElement("order_id"));
                $orderidElement->appendChild($doc->createTextNode(strval($order['order_id'])));

                // システムID
                $system_idElement = $paymentinfoElement->appendChild($doc->createElement("system_id"));
                $system_idElement->appendChild($doc->createTextNode(strval(0)));

                // システム注文ID
                $system_order_idElement = $paymentinfoElement->appendChild($doc->createElement("system_order_id"));
                $system_order_idElement->appendChild($doc->createTextNode(strval('')));
            }
            // 注文IDがない場合、システムID＋システム注文IDを指定
            else {
                // 注文ID
                $orderidElement = $paymentinfoElement->appendChild($doc->createElement("order_id"));
                $orderidElement->appendChild($doc->createTextNode(strval(0)));

                // システムID
                $system_idElement = $paymentinfoElement->appendChild($doc->createElement("system_id"));
                $system_idElement->appendChild($doc->createTextNode(strval($system_id)));

                // システム注文ID
                $system_order_idElement = $paymentinfoElement->appendChild($doc->createElement("system_order_id"));
                $system_order_idElement->appendChild($doc->createTextNode(strval($order['system_order_id'])));
            }

            // 注文ステータス
        //    $statusElement = $paymentinfoElement->appendChild($doc->createElement("status"));
            // 20160211-sode タグ名はstatus ではなくorder_statusがただしい
            $statusElement = $paymentinfoElement->appendChild($doc->createElement("order_status"));
            $statusElement->appendChild($doc->createTextNode(strval($order['status'])));


            //　20160211-sode 支払済み額もステータス強制変更時は不要
            if ($order['status'] != 99) {// 20160208- 変更 ステータス強制変更（order_status=99を更新）する際はpayment_unit_info句は不要

            	//20160206-sode 支払済み額（支払額と同じ値が入る）
            	$total_paidElement = $paymentinfoElement->appendChild($doc->createElement("total_paid"));
            	$total_paidElement->appendChild($doc->createTextNode(strval($order['paid_amount'])));

            // 支払い単位情報
            $payment_unit_infoElement = $paymentinfoElement->appendChild($doc->createElement("payment_unit_info"));

            // 連番
            $sequenceElement = $payment_unit_infoElement->appendChild($doc->createElement("sequence"));
            $sequenceElement->appendChild($doc->createTextNode(strval($order['sequence'])));

            // 支払い額
            $paid_amountElement = $payment_unit_infoElement->appendChild($doc->createElement("paid_amount"));
            $paid_amountElement->appendChild($doc->createTextNode(strval($order['paid_amount'])));

            // 支払い期日 or 最終入金日
            $dateElement = $payment_unit_infoElement->appendChild($doc->createElement("date"));
            $dateElement->appendChild($doc->createTextNode(strval($order['date'])));
          }

            $rootElement->appendChild($paymentinfoElement);
        }

        // 文字列化
        $xmlData = $doc->saveXML();

        //20160211 temp-sode テスト用
        //	echo $xmlData;

        return $xmlData;
    }

    /**
     * API連携実行
     *
     * @param string $url API連携URL
     * @param string $params POSTするリクエストパラメータ
     * @throws LogicCreditJudgeSystemConnectException
     * @throws Exception
     */
    private function apiConnect($url, $params) {
        $client = new Client($url);

        //タイムアウト時刻取得
        $time_out = $this->configs['cj_api']['timeout_time'];

        //タイムアウト設定
        $client->setOptions(array('timeout' => $time_out, 'keepalive' => true, 'maxredirects' => 1));  // 試行回数(maxredirects) を 1 に設定

        try {
            // データ送信を実行する
            $response = $client
                ->setRawBody($params)
                ->setEncType('application/xml; charset=UTF-8', ';')
                ->setMethod('Post')
                ->send();

            // 結果を取得する
            $status = $response->getStatusCode();
            $res_msg = $response->getReasonPhrase();
            $res_msg = mb_convert_encoding($res_msg, mb_internal_encoding(), BaseIOUtility::detectEncoding($res_msg));

            if($status == 200) {
                // HTTPステータスが200だったら受信内容をそのまま返す
                return $response->getBody();
            }
            // ステータスが200以外の場合はコード1で例外をスロー
            throw new \Exception(sprintf('%s Request failed (%s : %s)', $url, $status, $res_msg), 1);
        }
        catch(\Exception $err) {
            if(!$err->getCode()) {
                // コード指定がない場合はタイムアウトと見なす
                throw new \Exception(sprintf('%s Request Timed out (%s)', $url, $err->getMessage()));
            }
            else {
                // それ以外はそのままキャッチした例外をスロー
                throw $err;
            }
        }
    }

    /**
     * 支払い情報編集APIのレスポンス解析
     *
     * @param string $response レスポンスデータ（XML文字列）
     * @return array レスポンス解析結果
     */
    private function getResponseInfoPayment($response) {
        // SimpleXMLを経由して連想配列に展開
        $xml_param = simplexml_load_string($response);
        $resp_data = get_object_vars($xml_param);

        // 結果
        $result = '';
        if (!is_null($resp_data['result'])) {
            $result = $resp_data['result'];
        }

        // エラーメッセージ
        $error_message = '';
        if (!is_null($resp_data['error_message'])) {
            $error_message = $resp_data['error_message'];
        }

        // 解析結果をまとめる
        $respResult = array();
        $respResult['result'] = $result;
        $respResult['error_message'] = $error_message;

        return $respResult;
    }

    /**
     * 顧客情報編集API連携
     */
    private function CustomerListImport() {

        $start = microtime(true);
$this->logger->info('CustomerListImport start');

        $mdlmc = new TableManagementCustomer($this->dbAdapter);      // 管理顧客

        // 顧客情報取得API連携URL取得
        $getCustomerInformationUrl = $this->configs['cj_api']['GetCustomerInformation'];

        // 顧客情報編集API連携URL取得
        $customerListImportUrl = $this->configs['cj_api']['CustomerListImport'];

        // 顧客情報編集API連携が必要なデータを取得
        $sql = <<<EOQ
SELECT (CASE
          WHEN IluCustomerId IS NOT NULL THEN 'U'
          ELSE                                'C'
        END) AS mode                                /* 編集モード */
     , IFNULL(IluCustomerId, 0) AS IluCustomerId    /* 与信顧客ID */
     , ManCustId                                    /* システム顧客ID */
     , NameKj                                       /* 氏名 */
     , NameKn                                       /* 氏名かな */
     , REPLACE(PostalCode, '-', '') AS PostalCode   /* 郵便番号 */
     , UnitingAddress                               /* 住所 */
     , Phone                                        /* 電話番号 */
     , MailAddress                                  /* メールアドレス */
     , (CASE
          WHEN BlackFlg = 1 THEN 'B'
          WHEN GoodFlg = 1 THEN  'W'
          ELSE                   'N'
        END) AS status                              /* ステータス */
     , 0 AS version                                 /* レコードバージョン */
  FROM T_ManagementCustomer
 WHERE GoodFlg = 1
    OR BlackFlg = 1
 ORDER BY ManCustId
EOQ;
        $ri = $this->dbAdapter->query ( $sql )->execute (null);
        $custDatas = ResultInterfaceToArray($ri);

        if (count($custDatas)) {
            // 対象がある場合のみ処理を実行

            $udcusts = array();
            $manCustIdList = array();
            foreach ($custDatas as $custData) {
                // 更新・削除顧客のIDを取得
                if (in_array($custData['mode'], array('U', 'D'))) {
                    $udcusts[$custData['ManCustId']] = $custData['IluCustomerId'];
                }
            }

            // 更新・削除顧客が存在する場合
            if (count($udcusts) > 0) {
                // 顧客情報取得API連携

                // リクエストパラメータ作成
                $reqParams = $this->createRequestParamsInfo($udcusts);

                // WebAPI連携実行
                $response = $this->apiConnect($getCustomerInformationUrl, $reqParams);

                // レスポンス解析
                $resData = $this->getResponseInfoInfo($response);

                //保存先取得
                $save_dir = $this->configs['cj_api'][LogicCreditJudgeOptions::SAVE_DIR];

                //送信データ保存
                $sent_data = $reqParams;
                $sent_path = f_path($save_dir, 'iko_customerinformation.xml', DIRECTORY_SEPARATOR);
                $sent_data_saved = @file_put_contents($sent_path, $sent_data);

                //受信データ保存
                $received_data = $response;
                $received_path = f_path($save_dir, sprintf('iko_customerinformation_%s.xml', date('YmdHis')), DIRECTORY_SEPARATOR);
                $received_data_saved = @file_put_contents($received_path, $received_data);

                // どちらかの保存に失敗した場合は例外
                if(!$sent_data_saved || !$received_data_saved) {
                    $files = array();
                    if(!$sent_data_saved) $files[] = $sent_path;
                    if(!$received_data_saved) $files[] = $received_path;
                    $msg = sprintf('cannot save log file: %s', join(' and ', $files));
                    throw new \Exception($msg);
                }

                // バージョンを反映
                foreach ($custDatas as $key=>$value) {
                    // 与信顧客IDで該当あり
                    if (!empty($resData[$value['IluCustomerId']])) {
                        $custDatas[$key]['version'] = $resData[$value['IluCustomerId']];
                    }
                }
            }

            // 顧客情報編集API連携

            // リクエストパラメータ作成
            $reqParams = $this->createRequestParamsImport($custDatas);

            // WebAPI連携実行
            $response = $this->apiConnect($customerListImportUrl, $reqParams);

            // レスポンス解析
            $resData = $this->getResponseInfoImport($response);

            //保存先取得
            $save_dir = $this->configs['cj_api'][LogicCreditJudgeOptions::SAVE_DIR];

            //送信データ保存
            $sent_data = $reqParams;
            $sent_path = f_path($save_dir, 'iko_customerlistimport.xml', DIRECTORY_SEPARATOR);
            $sent_data_saved = @file_put_contents($sent_path, $sent_data);

            //受信データ保存
            $received_data = $response;
            $received_path = f_path($save_dir, sprintf('iko_customerlistimport_%s.xml', date('YmdHis')), DIRECTORY_SEPARATOR);
            $received_data_saved = @file_put_contents($received_path, $received_data);

            // どちらかの保存に失敗した場合は例外
            if(!$sent_data_saved || !$received_data_saved) {
                $files = array();
                if(!$sent_data_saved) $files[] = $sent_path;
                if(!$received_data_saved) $files[] = $received_path;
                $msg = sprintf('cannot save log file: %s', join(' and ', $files));
                throw new \Exception($msg);
            }

            // DBに結果反映
            if ($resData['result'] == 'OK') {
                // 連携結果：OK

                // 受付番号
                $this->receipt_no = $resData['receipt_no'];
            }
            else {
                // 連携結果：NG

                // 受付番号
                $this->receipt_no = null;
            }
        }

$this->logger->info('CustomerListImport end');
$this->logger->info(sprintf('CustomerListImport elapsed time = %s', (microtime(true) - $start)));
    }

    /**
     * 顧客情報取得APIリクエストパラメータ作成
     *
     * @param array $data
     * @return string リクエストパラメータ（XML文字列）
     */
    private function createRequestParamsInfo($data) {
        // XMLデータ作成
        $doc = new \DOMDocument("1.0", "utf-8");

        // 顧客IDリスト
        $rootElement = $doc->appendChild($doc->createElement("customer_id_list"));

        foreach ($data as $key=>$value) {
            // 顧客ID
            $customeridElement = $doc->createElement("customer_id");
            $customeridElement->appendChild($doc->createTextNode(strval($value)));
            $rootElement->appendChild($customeridElement);
        }

        // 文字列化
        $xmlData = $doc->saveXML();

        return $xmlData;
    }

    /**
     * 顧客情報取得APIのレスポンス解析
     *
     * @param string $response レスポンスデータ（XML文字列）
     * @return array レスポンス解析結果
     */
    private function getResponseInfoInfo($response) {
        // SimpleXMLを経由して連想配列に展開
        $xml_param = simplexml_load_string($response);
        $resp_data = get_object_vars($xml_param);

        // 顧客一覧
        $customerList = array();

        //        if (isset($resp_data['customer_info'])) {
        // 20160210-sode 修正 想定とレスポンスXMLが異なるため
        //20160213-sode 修正 変数名
        if (isset($resp_data['customer_list']->customer_info)) {
        	// 複数ではない場合は直接フィールド名が入ってくるため整形
        	if (is_null($resp_data['customer_list']->customer_info[1])) {
        		$customer_info = new \stdClass();
        		$customer_info->id = intval($resp_data['customer_list']->customer_info->id);
        		$customer_info->version = intval($resp_data['customer_list']->customer_info->version);
        		$response_customers_array['customer_list']->customer_info[0] = $customer_info;
        		//   $customerList[$info['customer_id']] = $info['version'];
        	}
        	else {
        		$response_customers_array = $resp_data;
        	}
        	foreach($response_customers_array['customer_list']->customer_info as $key=>$param) {
        		$info = array();
        		$info['customer_id'] = intval($param->id);
        		$info['version'] = intval($param->version);
        		$customerList[$info['customer_id']] = $info['version'];
        	}
        /*
        if (isset($resp_data['customer_info'])) {
            // 複数ではない場合は直接フィールド名が入ってくるため整形
            if (!is_array($resp_data['customer_info'])) {
                $info = array();
                $info['customer_id'] = intval($resp_data['customer_info']->id);
                $info['version'] = intval($resp_data['customer_info']->version);

                $customerList[$info['customer_id']] = $info['version'];
            }
            else {
                foreach($resp_data['customer_info'] as $key=>$param) {
                    $info = array();
                    $info['customer_id'] = intval($param->id);
                    $info['version'] = intval($param->version);

                    $customerList[$info['customer_id']] = $info['version'];
                }
            }*/
        }

        return $customerList;
    }

    /**
     * 顧客情報編集APIリクエストパラメータ作成
     *
     * @param array $data
     * @return string リクエストパラメータ（XML文字列）
     */
    private function createRequestParamsImport($data) {

        // システムID
        $system_id = $this->configs['cj_api'][LogicCreditJudgeOptions::ILU_ID];

        // XMLデータ作成
        $doc = new \DOMDocument("1.0", "utf-8");

        // 顧客情報連携
//        $rootElement = $doc->appendChild($doc->createElement("customer_list"));

        //20160203-sode-add $doc->createCDATASection(
        $rootElement = $doc->appendChild($doc->createElement("customer_list2"));

        //20160205-sode-add
        $rootElement->setAttribute("xmlns:xsd", "http://www.w3.org/2001/XMLSchema");

        //20160205-sode-add
        $rootElement->setAttribute("xmlns:xsi", "http://www.w3.org/2001/XMLSchema-instance");

        foreach ($data as $customer) {
            // 顧客情報
            $customerinfoElement = $doc->createElement("customer_info");

            //20160203-sode-add
            $customerinfoElement->setAttribute("xmlns", "http://ilu.co.jp/yoshin/customer_list");

            // 編集モード
            $modeElement = $customerinfoElement->appendChild($doc->createElement("mode"));
//            $modeElement->appendChild($doc->createTextNode(strval($customer['mode'])));
            $modeElement->appendChild($doc->createTextNode($customer['mode']));

            // 与信顧客ID
            $idElement = $customerinfoElement->appendChild($doc->createElement("id"));
            $idElement->appendChild($doc->createTextNode(strval($customer['IluCustomerId'])));

            // 親顧客ID
            $parent_idElement = $customerinfoElement->appendChild($doc->createElement("parent_id"));
//            $parent_idElement->appendChild($doc->createTextNode(strval(0)));
            $parent_idElement->appendChild($doc->createTextNode(0));

            // システム情報
            $system_infoElement = $customerinfoElement->appendChild($doc->createElement("system_info"));

            // システムID
            $system_idElement = $system_infoElement->appendChild($doc->createElement("system_id"));
            $system_idElement->appendChild($doc->createTextNode(strval($system_id)));

            // システム顧客ID
            $system_customer_idElement = $system_infoElement->appendChild($doc->createElement("system_customer_id"));
            $system_customer_idElement->appendChild($doc->createTextNode(strval($customer['ManCustId'])));

            // 氏名
            $nameElement = $customerinfoElement->appendChild($doc->createElement("name"));
         //   $nameElement->appendChild($doc->createTextNode(strval($customer['NameKj'])));
            //20160203-sode-add
            $nameElement->appendChild($doc->createCDATASection($customer['NameKj']));

            // 氏名かな
            $name_kanaElement = $customerinfoElement->appendChild($doc->createElement("name_kana"));
        //    $name_kanaElement->appendChild($doc->createTextNode(strval($customer['NameKn'])));
            //20160203-sode-add
            $name_kanaElement->appendChild($doc->createCDATASection($customer['NameKn']));


            // 顧客住所
            $addressElement = $customerinfoElement->appendChild($doc->createElement("address"));

            // 住所種類
            $kindElement = $addressElement->appendChild($doc->createElement("kind"));
//            $kindElement->appendChild($doc->createTextNode(strval(0)));
            $kindElement->appendChild($doc->createTextNode(0));

            // 郵便番号
            $postal_codeElement = $addressElement->appendChild($doc->createElement("postal_code"));
//            $postal_codeElement->appendChild($doc->createTextNode($customer['PostalCode']));
            //20160203-sode-add
            $postal_codeElement->appendChild($doc->createCDATASection($customer['PostalCode']));

            // 住所
            $addressChildElement = $addressElement->appendChild($doc->createElement("address"));
//            $addressChildElement->appendChild($doc->createTextNode($customer['UnitingAddress']));
            //20160203-sode-add
            $addressChildElement->appendChild($doc->createCDATASection($customer['UnitingAddress']));


            // 電話番号
            $telnoElement = $customerinfoElement->appendChild($doc->createElement("telno"));
//            $telnoElement->appendChild($doc->createTextNode(strval($customer['Phone'])));
            //20160203-sode-add
            $telnoElement->appendChild($doc->createCDATASection($customer['Phone']));


            // メールアドレス
            $mailaddressElement = $customerinfoElement->appendChild($doc->createElement("mailaddress"));
//            $mailaddressElement->appendChild($doc->createTextNode(strval($customer['MailAddress'])));
            //20160203-sode-add
            $mailaddressElement->appendChild($doc->createCDATASection($customer['MailAddress']));


            // 職業
            $jobElement = $customerinfoElement->appendChild($doc->createElement("job"));
//            $jobElement->appendChild($doc->createTextNode(''));
            //20160203-sode-add
            $jobElement->appendChild($doc->createCDATASection(''));

            // ステータス
            $statusElement = $customerinfoElement->appendChild($doc->createElement("status"));
//            $statusElement->appendChild($doc->createTextNode(strval($customer['status'])));
            //20160203-sode-add
            $statusElement->appendChild($doc->createCDATASection($customer['status']));


            // 誕生日
            $birthElement = $customerinfoElement->appendChild($doc->createElement("birth"));
//            $birthElement->appendChild($doc->createTextNode(''));
            //20160203-sode-add
            $birthElement->appendChild($doc->createCDATASection(''));

            // 性別
            $sexElement = $customerinfoElement->appendChild($doc->createElement("sex"));
//            $sexElement->appendChild($doc->createTextNode(''));
            //20160203-sode-add
            $sexElement->appendChild($doc->createCDATASection(''));

            // 備考
            $noteElement = $customerinfoElement->appendChild($doc->createElement("note"));
 //           $noteElement->appendChild($doc->createTextNode(''));
            //20160203-sode-add
            $noteElement->appendChild($doc->createCDATASection(''));

            // レコードバージョン
            $versionElement = $customerinfoElement->appendChild($doc->createElement("version"));
            $versionElement->appendChild($doc->createTextNode(strval($customer['version'])));

            // 20160203 sode-del ILU松島氏より<order_info>以下は不要
            /*

            // 注文情報
            $order_infoElement = $customerinfoElement->appendChild($doc->createElement("order_info"));

            // 注文ID
            $order_idElement = $order_infoElement->appendChild($doc->createElement("order_id"));
            $order_idElement->appendChild($doc->createTextNode(''));

            // 注文日
            $order_dateElement = $order_infoElement->appendChild($doc->createElement("order_date"));
            $order_dateElement->appendChild($doc->createTextNode(''));

            // 支払い総額
            $total_amountElement = $order_infoElement->appendChild($doc->createElement("total_amount"));
            $total_amountElement->appendChild($doc->createTextNode(''));

            // 支払い済額
            $total_paidElement = $order_infoElement->appendChild($doc->createElement("total_paid"));
            $total_paidElement->appendChild($doc->createTextNode(''));

            // 注文ステータス
            $order_statusElement = $order_infoElement->appendChild($doc->createElement("order_status"));
            $order_statusElement->appendChild($doc->createTextNode(''));

            // システムID
            $order_system_idElement = $order_infoElement->appendChild($doc->createElement("system_id"));
            $order_system_idElement->appendChild($doc->createTextNode(''));

            // システム注文ID
            $system_order_idElement = $order_infoElement->appendChild($doc->createElement("system_order_id"));
            $system_order_idElement->appendChild($doc->createTextNode(''));

            // 支払い情報
            $payment_infoElement = $order_infoElement->appendChild($doc->createElement("payment_info"));

            // 支払い期日
            $date_for_paymentElement = $payment_infoElement->appendChild($doc->createElement("date_for_payment"));
            $date_for_paymentElement->appendChild($doc->createTextNode(''));

            // 要支払い額
            $amountElement = $payment_infoElement->appendChild($doc->createElement("amount"));
            $amountElement->appendChild($doc->createTextNode(''));

            // 支払い済額
            $paidElement = $payment_infoElement->appendChild($doc->createElement("paid"));
            $paidElement->appendChild($doc->createTextNode(''));

            // 最終支払い日
            $date_of_last_paidElement = $payment_infoElement->appendChild($doc->createElement("date_of_last_paid"));
            $date_of_last_paidElement->appendChild($doc->createTextNode(''));
            */

            $rootElement->appendChild($customerinfoElement);
        }

        // 文字列化
        $xmlData = $doc->saveXML();

        return $xmlData;
    }

    /**
     * 顧客情報編集APIのレスポンス解析
     *
     * @param string $response レスポンスデータ（XML文字列）
     * @return array レスポンス解析結果
     */
    private function getResponseInfoImport($response) {
        // SimpleXMLを経由して連想配列に展開
        $xml_param = simplexml_load_string($response);
        $resp_data = get_object_vars($xml_param);

        // 結果
        $result = '';
        if (!is_null($resp_data['result'])) {
            $result = $resp_data['result'];
        }

        // エラーメッセージ
        $error_message = '';
        if (!is_null($resp_data['error_message'])) {
            $error_message = $resp_data['error_message'];
        }

        // 受付番号
        $receipt_no = '';
        if ($result == 'OK') {
            $receipt_no = $resp_data['receipt_no'];
        }

        // 解析結果をまとめる
        $respResult = array();
        $respResult['result'] = $result;
        $respResult['error_message'] = $error_message;
        $respResult['receipt_no'] = $receipt_no;

        return $respResult;
    }

    /**
     * 顧客情報編集結果取得API連携
     */
    private function GetCustomerListImportResult() {

        if (is_null($this->receipt_no)) {
            // 顧客情報編集をしていない場合終了
$this->logger->info('GetCustomerListImportResult skip');
            return;
        }

        $start = microtime(true);
$this->logger->info('GetCustomerListImportResult start');

        $mdlmc = new TableManagementCustomer($this->dbAdapter);      // 管理顧客

        // 顧客情報編集結果取得API連携URL取得
        $getCustomerListImportResultUrl = $this->configs['cj_api']['GetCustomerListImportResult'];

        // 顧客情報編集結果取得API連携

        // リクエストパラメータ作成
        $reqParams = $this->createRequestParamsResult($this->receipt_no);

        // WebAPI連携実行
        $response = $this->apiConnect($getCustomerListImportResultUrl, $reqParams);

        // レスポンス解析
        $resData = $this->getResponseInfoResult($response);

        //保存先取得
        $save_dir = $this->configs['cj_api'][LogicCreditJudgeOptions::SAVE_DIR];

        //送信データ保存
        $sent_data = $reqParams;
        $sent_path = f_path($save_dir, 'iko_getcustomerlistimportresult.xml', DIRECTORY_SEPARATOR);
        $sent_data_saved = @file_put_contents($sent_path, $sent_data);

        //受信データ保存
        $received_data = $response;
        $received_path = f_path($save_dir, sprintf('iko_getcustomerlistimportresult_%s.xml', date('YmdHis')), DIRECTORY_SEPARATOR);
        $received_data_saved = @file_put_contents($received_path, $received_data);

        // どちらかの保存に失敗した場合は例外
        if(!$sent_data_saved || !$received_data_saved) {
            $files = array();
            if(!$sent_data_saved) $files[] = $sent_path;
            if(!$received_data_saved) $files[] = $received_path;
            $msg = sprintf('cannot save log file: %s', join(' and ', $files));
            throw new \Exception($msg);
        }

        // DBに結果反映
        try {
            // トランザクション開始
            $this->dbAdapter->getDriver()->getConnection()->beginTransaction();

            if ($resData['result'] == 'OK') {
                // 連携結果：OK

                // 管理顧客の更新
                // 成功顧客
                foreach ($resData['success_customers'] as $info) {
                    $mc = $mdlmc->find($info['system_customer_id'])->current();

                    // 該当顧客が存在し、審査システム顧客IDが未設定の場合更新
                    if ($mc !== false && is_null($mc['IluCustomerId'])) {
                        $mdlmc->saveUpdate(array(
                                'IluCustomerId' => $info['customer_id'],    // 審査システム－顧客ＩＤ
                                'UpdateId' => $this->userId,                // 更新者
                        )
                        , $info['system_customer_id']
                        );
                    }
                }
            }

            // コミット
            $this->dbAdapter->getDriver()->getConnection()->commit();
        }
        catch (\Exception $ex) {
            // ロールバック
            $this->dbAdapter->getDriver()->getConnection()->rollBack();
            throw $ex;
        }

$this->logger->info('GetCustomerListImportResult end');
$this->logger->info(sprintf('GetCustomerListImportResult elapsed time = %s', (microtime(true) - $start)));
    }

    /**
     * 顧客情報編集結果APIリクエストパラメータ作成
     *
     * @param array $data
     * @return string リクエストパラメータ（XML文字列）
     */
    private function createRequestParamsResult($receipt_no) {
        // XMLデータ作成
        $doc = new \DOMDocument("1.0", "utf-8");

        // 受付
        $rootElement = $doc->appendChild($doc->createElement("receipt"));

        // 受付番号
        $receiptnoElement = $doc->createElement("receipt_no");
        $receiptnoElement->appendChild($doc->createTextNode(strval($receipt_no)));
        $rootElement->appendChild($receiptnoElement);

        // 文字列化
        $xmlData = $doc->saveXML();

        return $xmlData;
    }

    /**
     * 顧客情報編集結果APIのレスポンス解析
     *
     * @param string $response レスポンスデータ（XML文字列）
     * @return array レスポンス解析結果
     */
    private function getResponseInfoResult($response) {
        // SimpleXMLを経由して連想配列に展開
        $xml_param = simplexml_load_string($response);
        $resp_data = get_object_vars($xml_param);

        // 結果
        $result = '';
        if (!is_null($resp_data['result'])) {
            $result = $resp_data['result'];
        }

        // エラーコード
        $error_code = '';
        if (!is_null($resp_data['error_code'])) {
            $error_code = $resp_data['error_code'];
        }

        if ($result == 'OK') {
            // 成功顧客
            $success_customers = array();
            // 複数ではない場合は直接フィールド名が入ってくるため整形
            if (is_null($resp_data['success_customers']->import_info[1])) {
                $import_info = new \stdClass();
                $import_info->customer_id = intval($resp_data['success_customers']->import_info->customer_id);
                $import_info->system_customer_id = intval($resp_data['success_customers']->import_info->system_customer_id);
                $success_customers_array['success_customers']->import_info[0] = $import_info;
            }
            else {
                $success_customers_array = $resp_data;
            }
            // 顧客ID、システム顧客IDのペアを連想配列に整形
            foreach($success_customers_array['success_customers']->import_info as $key=>$param) {
                $info = array();
                $info['customer_id'] = intval($param->customer_id);
                $info['system_customer_id'] = intval($param->system_customer_id);
                $success_customers[] = $info;
            }

            // 失敗顧客
            $faild_customers = array();
            // 複数ではない場合は直接フィールド名が入ってくるため整形
            if (is_null($resp_data['faild_customers']->import_info[1])) {
                $import_info = new \stdClass();
                $import_info->customer_id = intval($resp_data['faild_customers']->import_info->customer_id);
                $import_info->system_customer_id = intval($resp_data['faild_customers']->import_info->system_customer_id);
                $faild_customers_array['faild_customers']->import_info[0] = $import_info;
            }
            else {
                $faild_customers_array = $resp_data;
            }
            // 顧客ID、システム顧客IDのペアを連想配列に整形
            foreach($faild_customers_array['faild_customers']->import_info as $key=>$param) {
                $info = array();
                $info['customer_id'] = intval($param->customer_id);
                $info['system_customer_id'] = intval($param->system_customer_id);
                $faild_customers[] = $info;
            }
        }

        // 解析結果をまとめる
        $respResult = array();
        $respResult['result'] = $result;
        $respResult['error_code'] = $error_code;
        $respResult['success_customers'] = $success_customers;
        $respResult['faild_customers'] = $faild_customers;

        return $respResult;
    }
}

Application::setArgv($argv);
Application::getInstance()->run();
